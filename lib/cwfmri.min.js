!function(root,factory){"object"==typeof exports&&"object"==typeof module?module.exports=factory(require("experiment-js"),require("experiment-babylon-js"),require("lodash"),require("experiment-boxes"),require("experiment-mathjs"),require("jQuery")):"function"==typeof define&&define.amd?define("cwfmri",["experiment-js","experiment-babylon-js","lodash","experiment-boxes","experiment-mathjs","jQuery"],factory):"object"==typeof exports?exports.cwfmri=factory(require("experiment-js"),require("experiment-babylon-js"),require("lodash"),require("experiment-boxes"),require("experiment-mathjs"),require("jQuery")):root.cwfmri=factory(root.experiment,root.BABYLON,root._,root.experimentBoxes,root.math,root.jQuery)}(this,function(__WEBPACK_EXTERNAL_MODULE_0__,__WEBPACK_EXTERNAL_MODULE_1__,__WEBPACK_EXTERNAL_MODULE_2__,__WEBPACK_EXTERNAL_MODULE_4__,__WEBPACK_EXTERNAL_MODULE_15__,__WEBPACK_EXTERNAL_MODULE_16__){return function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}var installedModules={};return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.i=function(value){return value},__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{configurable:!1,enumerable:!0,get:getter})},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=8)}([function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_0__},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_1__},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_2__},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getAspectRatio=exports.getBaseGraphMatrices=exports.computeValidStateSpace=exports.getTransitionMatrixFromBase=exports.getRandomTransitionMatrix=exports.getZeroOrderTransitionMatrix=exports.positionToVector=exports.vectorToPosition=exports.sampleTransitions=exports.sampleNextTransition=exports.getValidTransitionArray=exports.getDominantCellByRow=exports.getDominantProbabilityByRow=exports.matrixKlDivergence=exports.getObservedArrays=exports.getObservedAndDistanceMatrix=exports.smoothSequenceDistribution=exports.promiseSequenceFromTransitionMatrix=exports.promiseMultipleSequences=exports.promiseMultipleRandomSequences=exports.promiseSegmentsAndProbesByBlock=exports.getFullSequenceObjectForRandomBlackoutBlock=exports.promiseFullSequenceForIntermitentPrediction=exports.promiseFullSequenceForOneLevel=exports.getFullSequenceObjectForClassicLevels=exports.insertSequenceObjectAtBlock=exports.promiseBestSequencesForAllBlocksAndSave=exports.getDensity=exports.randomColor=exports.computeDurationEstimate=exports.learnerPredict=exports.updateWithRule=exports.prediction=exports.softMaxByRow=exports.sampleExponential=void 0;var _experimentMathjs=__webpack_require__(15),_experimentMathjs2=_interopRequireDefault(_experimentMathjs),_lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentJs=__webpack_require__(0),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),getAspectRatio=function(){var surfaceObject=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();if(surfaceObject.constructor===_experimentBabylonJs2.default.Texture){var _surfaceObject$getBas=surfaceObject.getBaseSize();return _surfaceObject$getBas.width/_surfaceObject$getBas.height}throw new Error("getAspectRatio: object type not valid.")},getBaseGraphMatrices=function(){var graphMatrix1=(0,_experimentJs.matrix)(4,4,0),graphMatrix2=(0,_experimentJs.matrix)(4,4,0);return graphMatrix1[0][1]=graphMatrix1[1][2]=graphMatrix1[2][3]=graphMatrix1[3][0]=1,graphMatrix2[0][2]=graphMatrix2[1][3]=graphMatrix2[2][1]=graphMatrix2[3][0]=1,{A:graphMatrix1,B:_experimentMathjs2.default.transpose(graphMatrix1),C:graphMatrix2,D:_experimentMathjs2.default.transpose(graphMatrix2)}},computeValidStateSpace=function(){var taskObject=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)("taskObject"),options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(resolve,reject){taskObject.constructor!==_experimentJs.TaskObject&&reject("computeValidGraphs promise: taskObject is not of class TaskObject.");var optionsBase={maxNumberOfCycles:2,stateSpace:null};options=_lodash2.default.extend(optionsBase,options);for(var stateSpace=options.stateSpace,rules=taskObject.parameters.rules,rulesProportions=taskObject.parameters.rulesProportions,proportionThreshold=0,rulesData=[],i=0;i<rules.length;i++)rulesData.push({rule:rules[i],proportion:rulesProportions[i],threshold:proportionThreshold}),proportionThreshold+=rulesProportions[i];var numberOfRows=taskObject.parameters.numberOfRows,numberOfTargets=Math.pow(taskObject.parameters.numberOfRows,2),linearRules=_lodash2.default.without(taskObject.parameters.rules,"random","oneBackThenRight");if(null===stateSpace){stateSpace=[];for(var _i=0;_i<numberOfTargets;_i++)!function(_i){var currentTarget={};currentTarget.position=_i;var beginLineIndex=Math.floor(_i/numberOfRows)*numberOfRows,downIndex=(_i+numberOfRows*(numberOfRows-1))%(numberOfRows*numberOfRows),upIndex=(_i+numberOfRows)%(numberOfRows*numberOfRows),rightIndex=(_i-(beginLineIndex+1))%numberOfRows+beginLineIndex,leftIndex=(_i-beginLineIndex+(numberOfRows-1))%numberOfRows+beginLineIndex;currentTarget.closestTargets={up:upIndex,left:leftIndex,down:downIndex,right:rightIndex};var randomNumber=Math.random(),currentRuleData=_lodash2.default.clone(_lodash2.default.find(rulesData,function(e){var d=randomNumber-e.threshold;return d<=e.proportion&&d>0}));switch("random"===currentRuleData.rule&&(currentRuleData.rule=_lodash2.default.sample(linearRules)),currentTarget.rule=currentRuleData.rule,currentTarget.rule){case"up":currentTarget.nextPosition=upIndex;break;case"down":currentTarget.nextPosition=downIndex;break;case"left":currentTarget.nextPosition=leftIndex;break;case"right":currentTarget.nextPosition=rightIndex;break;case"oneBackThenRight":currentTarget.nextPosition="last";break;default:throw new Error("getHiddenStateMatrixFromDistribution: state at "+currentTarget.position+" of the distribution aray has an invalid rule "+currentTarget.rule)}stateSpace.push(currentTarget)}(_i)}for(var loopOnStateSpace=0;loopOnStateSpace<110;){var hiddenSpace=function recursivelyExpandStateSpace(){var lStateSpace=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),loopIndex=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)(),timeIndependantRules=["up","right","down","left"];if(loopIndex>50)return!1;for(var newSpace=[],recurse=!1,k=0;k<lStateSpace.length;k++){if("break"===function(k){var state=_lodash2.default.clone(lStateSpace[k]);if(void 0===state.nextHiddenState&&(state.nextHiddenState=state.nextPosition),void 0===state.hiddenStateIndex&&(state.hiddenStateIndex=state.position),"last"===state.nextHiddenState&&(state.nextHiddenState=_lodash2.default.sample(state.closestTargets),state.nextPosition=state.nextHiddenState),"oneBackThenRight"===lStateSpace[state.nextHiddenState].rule){var firstTargetHiddenState=_lodash2.default.clone(lStateSpace[state.nextHiddenState]);firstTargetHiddenState.hiddenStateIndex=lStateSpace.length,firstTargetHiddenState.rule=_lodash2.default.findKey(firstTargetHiddenState.closestTargets,function(p){return p===state.position});var secondTargetHiddenState=_lodash2.default.clone(state);secondTargetHiddenState.hiddenStateIndex=lStateSpace.length+1;var thirdTargetHiddenState=_lodash2.default.clone(lStateSpace[state.nextHiddenState]);return thirdTargetHiddenState.hiddenStateIndex=lStateSpace.length+2,thirdTargetHiddenState.rule=timeIndependantRules[(timeIndependantRules.indexOf(firstTargetHiddenState.rule)+1)%4],thirdTargetHiddenState.nextPosition=thirdTargetHiddenState.closestTargets[thirdTargetHiddenState.rule],state.nextHiddenState=firstTargetHiddenState.hiddenStateIndex,firstTargetHiddenState.nextHiddenState=secondTargetHiddenState.hiddenStateIndex,secondTargetHiddenState.nextHiddenState=thirdTargetHiddenState.hiddenStateIndex,thirdTargetHiddenState.nextHiddenState=thirdTargetHiddenState.nextPosition,newSpace.push(state),newSpace=_lodash2.default.concat(newSpace,_lodash2.default.slice(lStateSpace,k+1)),newSpace.push(firstTargetHiddenState),newSpace.push(secondTargetHiddenState),newSpace.push(thirdTargetHiddenState),recurse=!0,"break"}newSpace.push(state)}(k))break}return(0,_experimentJs.debuglog)("recursivelyExpandStateSpace: loopIndex "+loopIndex+" recurse "+recurse),(0,_experimentJs.debuglog)(newSpace),recurse?recursivelyExpandStateSpace(newSpace,loopIndex+1):((0,_experimentJs.debuglog)("were here god damnit"),newSpace)}(stateSpace,0);if(!1===hiddenSpace){resolve("computeValidGraphs: could not expand state space.");break}(0,_experimentJs.debuglog)("were past hiddenSpace loopOnStateSpace"+loopOnStateSpace);var transitionMatrix=function(){var lStateSpace=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();if(lStateSpace.constructor!==Array)throw(0,_experimentJs.debuglog)(lStateSpace),new Error("transitionMatrixFromStateSpace: stateSpace is not an array.");for(var transitionMatrix=_experimentMathjs2.default.zeros(lStateSpace.length,lStateSpace.length),_i2=0;_i2<lStateSpace.length;_i2++){if(void 0===lStateSpace[_i2].nextHiddenState)throw new Error("transitionMatrixFromStateSpace: state "+_i2+" has an undefined nextHiddenState");transitionMatrix.subset(_experimentMathjs2.default.index(_i2,lStateSpace[_i2].nextHiddenState),1)}return transitionMatrix}(hiddenSpace),cycles=function(){var transitionMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),maxTransitions=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64;if(void 0===transitionMatrix._size)throw new Error("getCyclesFromTransitionMatrix: transitionMatrix._size is undefined.");var spaceSize=transitionMatrix._size;if(spaceSize[0]!==spaceSize[1])throw new Error("getCyclesFromTransitionMatrix: transitionMatrix is not square.");for(var positionsInCycle=[],cycles=[],_i3=0;_i3<spaceSize[0];_i3++)if(-1===positionsInCycle.indexOf(_i3)){var currentCyclePositions=[],startingPosition=_experimentMathjs2.default.zeros(1,spaceSize[0]);startingPosition.subset(_experimentMathjs2.default.index(0,_i3),1);var currentPositionVector=_lodash2.default.clone(startingPosition),currentPosition=_experimentMathjs2.default.flatten(currentPositionVector)._data.indexOf(1);currentCyclePositions.push(currentPosition);for(var numberOfTransitions=1;numberOfTransitions<maxTransitions;){currentPositionVector=_experimentMathjs2.default.multiply(currentPositionVector,transitionMatrix),currentPosition=_experimentMathjs2.default.flatten(currentPositionVector)._data.indexOf(1);var currentPositionIndexInCycle=currentCyclePositions.indexOf(currentPosition);if(-1!==currentPositionIndexInCycle){var cycle=_lodash2.default.slice(currentCyclePositions,currentPositionIndexInCycle);positionsInCycle=_lodash2.default.union(positionsInCycle,cycle),cycles.push(cycle);break}if(-1!==positionsInCycle.indexOf(currentPosition))break;currentCyclePositions.push(currentPosition),numberOfTransitions+=1}}return cycles}(transitionMatrix);if(!(cycles.length>options.maxNumberOfCycles))break;(0,_experimentJs.debuglog)("too many cycles"),loopOnStateSpace+=1;for(var smallestSize=-1,smallestCycleIndex=0,_i4=0;_i4<cycles.length;_i4++)(-1===smallestSize||cycles[_i4].length<smallestSize)&&(smallestSize=cycles[_i4].length,smallestCycleIndex=_i4);var positionToChange=hiddenSpace[_lodash2.default.sample(cycles[smallestCycleIndex])].position;if(stateSpace=function(){var lStateSpace=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),position=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)();if(void 0===lStateSpace[position])throw new Error("sampleNewRule: lStateSpace["+position+"] is undefined.");var state=lStateSpace[position],randomNumber=Math.random(),currentRuleData=_lodash2.default.clone(_lodash2.default.find(rulesData,function(e){var d=randomNumber-e.threshold;return d<=e.proportion&&d>0}));switch("random"===currentRuleData.rule&&(currentRuleData.rule=_lodash2.default.sample(linearRules)),state.rule=currentRuleData.rule,state.rule){case"up":state.nextPosition=state.closestTargets.up;break;case"down":state.nextPosition=state.closestTargets.down;break;case"left":state.nextPosition=state.closestTargets.left;break;case"right":state.nextPosition=state.closestTargets.right;break;case"oneBackThenRight":state.nextPosition="last";break;default:throw new Error("getHiddenStateMatrixFromDistribution: state at "+position+" of the distribution aray has an invalid rule "+state.rule)}return lStateSpace}(stateSpace,positionToChange),loopOnStateSpace>100){resolve("computeValidGraphs: could not converge to a valid graph");break}}taskObject.parameters.validStateSpaces.push(stateSpace),resolve("computeValidGraphs: a valid stateSpace was stored in taskObject.parameters.validStateSpaces array.")})},getTransitionMatrixFromBase=function(){var baseMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),mainTransitionProbability=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)(),noSelfTransition=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];baseMatrix=_experimentMathjs2.default.matrix(baseMatrix);var size=baseMatrix.size()[0]-1;return baseMatrix.map(function(value,index){if(noSelfTransition&&index[0]===index[1])return 0;switch(value){case 0:return(1-mainTransitionProbability)/(size-(noSelfTransition?1:0));case 1:return mainTransitionProbability;default:throw new Error("taskObject.getTransitionMatrix: mainTransitionProbability is not 0 or 1")}})},getValidTransitionArray=function(){var transitionArray=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();if(transitionArray.constructor!==Array){if("function"!=typeof transitionArray.toArray)throw new Error("TaskObject.getValidTransitionArray: transitionArray is not an array and cannot be coerced to array.");transitionArray=transitionArray.toArray()}if(!transitionArray.length)throw new Error("TaskObject.getValidTransitionArray: transitionArray is empty.");for(var lengths=[],i=0;i<transitionArray.length;i++)lengths[i]=transitionArray[i].length;var uniqueLengths=lengths.uniqueValues();if(1!==uniqueLengths.length)throw new Error("TaskObject.getValidTransitionArray: rows are of multiple lengths.");if(transitionArray.length!==uniqueLengths[0])throw new Error("TaskObject.getValidTransitionArray: transition array is not square.");return transitionArray},getRandomTransitionMatrix=function(stateProbabilities){var outputType=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"array",size=stateProbabilities.length,baseMatrix=_experimentMathjs2.default.matrix((0,_experimentJs.matrix)(size,size,0)),transitionMatrix=baseMatrix.map(function(value,index){return stateProbabilities[index[1]]});return"array"===outputType?getValidTransitionArray(transitionMatrix):transitionMatrix},getZeroOrderTransitionMatrix=function(){var dominantPosition=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),dominantProbability=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)(),numberOfStates=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,nonDominantProbability=Math.round((1-dominantProbability)/(numberOfStates-1)*100)/100,rowValue=(0,_experimentJs.rep)(nonDominantProbability,numberOfStates);return rowValue[dominantPosition]=dominantProbability,getRandomTransitionMatrix(rowValue)},positionToVector=function(){var position=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),numberOfPositions=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;if(Number.isInteger(position)){var vectorPosition=(0,_experimentJs.rep)(0,numberOfPositions);return vectorPosition[position]=1,vectorPosition=_experimentMathjs2.default.matrix(vectorPosition)}throw new Error("taskObject.positionToVector: position is not numeric.")},vectorToPosition=function(){var vector=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();if(vector.constructor!==_experimentMathjs2.default.matrix().constructor){if(vector.constructor!==Array)throw new Error("taskObject.vectorToPosition: vector is not of type math.matrix() or Array");vector=_experimentMathjs2.default.matrix(vector)}if(vector.size().length>1)throw new Error("taskObject.vectorToPosition: vector has more than one dimension.");var position=null;if(vector.forEach(function(value,index){switch(value){case 1:if(null!==position)throw new Error("taskObject.vectorToPosition: vector has more than one entry equal to 1.");position=index[0];break;case 0:break;default:throw new Error("taskObject.vectorToPosition: vector has at least one entry not equal to 0 or 1. Entry "+value)}}),null===position)throw new Error("taskObject.vectorToPosition: no entry equal to one was found in vector, position is null.");return position},sampleNextTransition=function(){var transitionMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),currentPosition=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)();if(Number.isInteger(currentPosition)&&(currentPosition=positionToVector(currentPosition,_experimentMathjs2.default.size(transitionMatrix)[0])),transitionMatrix=_experimentMathjs2.default.matrix(transitionMatrix),currentPosition.size()[0]!==transitionMatrix.size()[0])throw new Error("taskObject.sampleNextTransition: currentPosition vector is not of same size as transitionMatrix");var nextPositionProbabilities=_experimentMathjs2.default.multiply(_experimentMathjs2.default.transpose(currentPosition),transitionMatrix),count=0,randomNumber=Math.random(),nextPosition=null;if(nextPositionProbabilities.map(function(value,index){return randomNumber>count&&(nextPosition=index[0]),count+=value}),null===nextPosition)throw new Error("taskObject.sampleNextTransition: nextPosition is null");return nextPosition},sampleTransitions=function(){var transitionMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),startPosition=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)(),numberOfTransitions=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,_experimentJs.mandatory)(),includeStart=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],vectorPosition=void 0;Number.isInteger(startPosition)?vectorPosition=positionToVector(startPosition):(vectorPosition=startPosition,startPosition=vectorToPosition(vectorPosition));var transitions=[];includeStart&&transitions.push(startPosition);for(var j=transitions.length;j<numberOfTransitions;j++){var sampledPosition=sampleNextTransition(transitionMatrix,vectorPosition);transitions.push(sampledPosition),vectorPosition=positionToVector(sampledPosition)}return transitions},getDominantCellByRow=function(){var transitionArray=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();transitionArray=getValidTransitionArray(transitionArray);for(var dominantArray=(0,_experimentJs.matrix)(transitionArray.length,transitionArray.length,0),i=0;i<transitionArray.length;i++){var indicesOfMaxValue=transitionArray[i].indicesOf(_lodash2.default.max(transitionArray[i]));indicesOfMaxValue.length>1&&console.warn("TaskObject.getDominantCellByRow: "+indicesOfMaxValue.length+" cells in row "+i+" of transition matrix are ex-aequo. Sampling one of them as dominant.");var maxIndex=_lodash2.default.sample(indicesOfMaxValue);dominantArray[i][maxIndex]=1}return dominantArray},getDominantProbabilityByRow=function(){var transitionArray=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();return transitionArray=getValidTransitionArray(transitionArray),_lodash2.default.map(transitionArray,function(value){return _lodash2.default.max(value)})},matrixKlDivergence=function(){var qMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),pMatrix=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)();if(qMatrix.constructor!==_experimentMathjs2.default.matrix().constructor){if(qMatrix.constructor!==Array)throw new Error("taskObject.vectorToPosition: qMatrix is not of type math.matrix() or Array");qMatrix=_experimentMathjs2.default.matrix(qMatrix)}if(pMatrix.constructor!==_experimentMathjs2.default.matrix().constructor){if(pMatrix.constructor!==Array)throw new Error("taskObject.vectorToPosition: pMatrix is not of type math.matrix() or Array");pMatrix=_experimentMathjs2.default.matrix(pMatrix)}var flattenQDistribution=_experimentMathjs2.default.flatten(qMatrix),flattenPDistribution=_experimentMathjs2.default.flatten(pMatrix);return _experimentMathjs2.default.kldivergence(flattenQDistribution,flattenPDistribution)},getProportionArray=function(){for(var absolutes=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),sumRow=[],proportionArray=[],i=0;i<absolutes.length;i++)if(absolutes[i].constructor===Array){sumRow[i]=_experimentMathjs2.default.sum(absolutes[i]),proportionArray[i]=[];for(var j=0;j<absolutes[i].length;j++)proportionArray[i][j]=absolutes[i][j]/sumRow[i]}else sumRow[i]=_experimentMathjs2.default.sum(absolutes),proportionArray[i]=absolutes[i]/sumRow[i];return proportionArray},getObservedArrays=function(){var sequence=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),transitionMatrix=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,size=4;null!==transitionMatrix&&(size=getValidTransitionArray(transitionMatrix).length);for(var observedTransitionArray=(0,_experimentJs.matrix)(size,size,0),i=0;i<sequence.length-1;i++)observedTransitionArray[sequence[i]][sequence[i+1]]+=1;return{absolutes:observedTransitionArray,proportions:getProportionArray(observedTransitionArray)}},getObservedAndDistanceMatrix=function(){var sequence=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),transitionMatrix=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)();transitionMatrix=getValidTransitionArray(transitionMatrix);var observedArrays=getObservedArrays(sequence,transitionMatrix),observedMatrix=_experimentMathjs2.default.matrix(observedArrays.proportions),distanceMatrix=_experimentMathjs2.default.subtract(transitionMatrix,observedMatrix);return{observedMatrix:observedMatrix,distanceMatrix:distanceMatrix,totalError:_experimentMathjs2.default.sum(_experimentMathjs2.default.abs(distanceMatrix))}},smoothSequenceDistribution=function(sequence,transitionMatrix){var errorThreshold=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.05,numberOfNewTransitions=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;transitionMatrix=getValidTransitionArray(transitionMatrix);for(var resultObject=getObservedAndDistanceMatrix(sequence,transitionMatrix),distanceMatrix=resultObject.distanceMatrix,size=_experimentMathjs2.default.size(transitionMatrix)[0],unevenPosition=[],i=0;i<size;i++)if((0,_experimentJs.rowSum)(_experimentMathjs2.default.abs(distanceMatrix),i)>errorThreshold){var rowArray=(0,_experimentJs.getRow)(distanceMatrix,i).toArray();rowArray=rowArray[0];var maxVariations=_lodash2.default.sortBy(rowArray),positionInformations=[i,rowArray.indexOf(maxVariations[0]),maxVariations[0],rowArray.indexOf(maxVariations[size-1]),maxVariations[size-1]];unevenPosition.push(positionInformations)}var newSequence=sequence;if(unevenPosition.length>0){for(var pickedUneven=unevenPosition[_lodash2.default.random(0,unevenPosition.length-1)],smoothedPosition=pickedUneven[0],allIndices=sequence.indicesOf(smoothedPosition),highTransitionIndices=_lodash2.default.filter(allIndices,function(i){return sequence[i+1]===pickedUneven[1]}),replacedIndex=_lodash2.default.sample(highTransitionIndices),addedTransitions=[pickedUneven[3]],vectorPosition=positionToVector(pickedUneven[3]),j=1;j<numberOfNewTransitions;j++){var sampledPosition=sampleNextTransition(transitionMatrix,vectorPosition);addedTransitions.push(sampledPosition),vectorPosition=positionToVector(sampledPosition)}var restSequence=_lodash2.default.slice(sequence,replacedIndex+2),restartAt=restSequence.indexOf(addedTransitions[addedTransitions.length-1]);if(restSequence=-1===restartAt?sampleTransitions(transitionMatrix,addedTransitions[addedTransitions.length-1],restSequence.length):_lodash2.default.slice(restSequence,restartAt+1),newSequence=_lodash2.default.concat(_lodash2.default.slice(sequence,0,replacedIndex+1),addedTransitions,_lodash2.default.slice(restSequence,restartAt+1)),newSequence.length!==sequence.length)if(newSequence.length>sequence.length)newSequence=_lodash2.default.slice(newSequence,newSequence.length-sequence.length);else{var finishSequence=sampleTransitions(transitionMatrix,newSequence[newSequence.length-1],sequence.length-newSequence.length);newSequence=_lodash2.default.concat(newSequence,finishSequence)}return newSequence}return null},promiseSequenceFromTransitionMatrix=function(){var transitionMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return transitionMatrix=getValidTransitionArray(transitionMatrix),new Promise(function(resolve){var baseOptions={sequenceLength:50,errorThreshold:.06,numberOfNewTransitions:4,maxLoop:100};options=_lodash2.default.extend(baseOptions,options);var numberOfStates=_experimentMathjs2.default.size(transitionMatrix)[0],sequence=[],startPosition=_lodash2.default.random(0,numberOfStates-1);sequence.push(startPosition);for(var positionVector=positionToVector(startPosition),i=0;i<options.sequenceLength-1;i++){var nextPosition=sampleNextTransition(transitionMatrix,positionVector);positionVector=positionToVector(nextPosition),sequence.push(nextPosition)}for(var loop=0,maxLoop=options.maxLoop,bestSequence=null,bestError=100;loop<maxLoop;){var newSequence=smoothSequenceDistribution(sequence,transitionMatrix,options.errorThreshold,options.numberOfNewTransitions);if(null===newSequence)break;var resultObject=getObservedAndDistanceMatrix(newSequence,transitionMatrix),totalError=resultObject.totalError;(null===bestSequence||bestError>totalError)&&(bestSequence={sequence:newSequence,observedMatrix:resultObject.observedMatrix,distanceMatrix:resultObject.distanceMatrix},bestError=totalError),sequence=newSequence,loop+=1}resolve(null!==bestSequence?bestSequence.sequence:sequence)})},promiseMultipleSequences=function promiseMultipleSequences(){var transitionMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise(function(resolve){transitionMatrix=getValidTransitionArray(transitionMatrix);var baseOptions={numberOfSequences:6,sequenceLength:130,sequenceArray:[]};options=_lodash2.default.extend(baseOptions,options),(0,_experimentJs.debuglog)("Generated "+options.sequenceArray.length+" sequences"),options.sequenceArray.length<options.numberOfSequences?((0,_experimentJs.debuglog)(options.sequenceArray),promiseSequenceFromTransitionMatrix(transitionMatrix,{sequenceLength:options.sequenceLength}).then(function(sequence){options.sequenceArray.push(sequence),promiseMultipleSequences(transitionMatrix,options).then(function(sequences){resolve(sequences)})})):resolve(options.sequenceArray)})},promiseMultipleRandomSequences=function promiseMultipleRandomSequences(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return new Promise(function(resolve){var baseOptions={numberOfSequences:4,sequenceLength:30,dominantProbability:.4,dominantPositions:[0,1,2,3],errorThreshold:.02,maxLoop:1e4,numberOfNewTransitions:4,sequenceArray:[]};if(options=_lodash2.default.extend(baseOptions,options),(0,_experimentJs.debuglog)("Generated "+options.sequenceArray.length+" sequences"),options.sequenceArray.length<options.numberOfSequences){var transitionMatrix=getZeroOrderTransitionMatrix(options.sequenceArray.length,options.dominantProbability);promiseSequenceFromTransitionMatrix(transitionMatrix,{sequenceLength:options.sequenceLength,errorThreshold:options.errorThreshold,numberOfNewTransitions:options.numberOfNewTransitions,maxLoop:options.maxLoop}).then(function(sequence){options.sequenceArray.push(sequence),promiseMultipleRandomSequences(options).then(function(sequences){resolve(sequences)})})}else resolve(options.sequenceArray)})},promiseSegmentsAndProbesByBlock=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return new Promise(function(resolve){var baseOptions={segmentSizes:[3,4,5],observationSegmentRepetitionPerBlock:2,numberOfBlocks:6,dominantProbability:.75,positions:[0,1,2,3]};options=_lodash2.default.extend(baseOptions,options);for(var numberOfTimeAProbeIsRepeated=options.segmentSizes.length*options.observationSegmentRepetitionPerBlock,positions=options.positions,numberOfDominant=_experimentMathjs2.default.floor(options.dominantProbability*numberOfTimeAProbeIsRepeated),segmentSizeSequencesEvenlyDistributed=[],probeSequences=[],transitionTypes=[],blockArray=[],i=0;i<options.numberOfBlocks;i++){var segmentPermutations=(0,_experimentJs.samplePermutation)((0,_experimentJs.rep)(options.segmentSizes,positions.length*options.observationSegmentRepetitionPerBlock));blockArray=blockArray.concat((0,_experimentJs.rep)(i,segmentPermutations.length));for(var probeSequence=(0,_experimentJs.samplePermutation)((0,_experimentJs.rep)(options.positions,numberOfTimeAProbeIsRepeated)),loop=0;loop<100&&probeSequence.hasNeighbouringRepeat();)probeSequence=(0,_experimentJs.samplePermutation)((0,_experimentJs.rep)(options.positions,numberOfTimeAProbeIsRepeated)),loop+=1;for(var segmentEvenlyPermutated=[],leftSegmentPermutations=positions.map(function(){return(0,_experimentJs.samplePermutation)((0,_experimentJs.rep)(options.segmentSizes,options.observationSegmentRepetitionPerBlock))}),_i5=0;_i5<probeSequence.length;_i5++)if(segmentEvenlyPermutated[_i5]=leftSegmentPermutations[probeSequence[_i5]].pop(),void 0===segmentEvenlyPermutated[_i5])throw new Error("promiseSegmentsAndProbesByBlock: leftSegmentPermutations is empty cannot pop !");segmentSizeSequencesEvenlyDistributed=segmentSizeSequencesEvenlyDistributed.concat(segmentEvenlyPermutated),probeSequences=probeSequences.concat(probeSequence);for(var indices=_lodash2.default.range(probeSequence.length),transitionType=(0,_experimentJs.rep)(0,probeSequence.length),dominantCount=[0,0,0,0];indices.length;){var r=_lodash2.default.random(0,indices.length-1),index=indices.splice(r,1),position=probeSequences[index];dominantCount[position-1]>=numberOfDominant?transitionType[index]=0:(dominantCount[position-1]+=1,transitionType[index]=1)}transitionTypes=transitionTypes.concat(transitionType)}resolve({segmentSizeSequences:segmentSizeSequencesEvenlyDistributed,block:blockArray,probeSequences:probeSequences,transitionTypes:transitionTypes,numberOfProbePerBlock:options.segmentSizes.length*options.observationSegmentRepetitionPerBlock*options.positions.length,numberOfObservationPerBlock:_lodash2.default.sum(options.segmentSizes)*options.observationSegmentRepetitionPerBlock*options.positions.length})})},getFullSequenceObjectForRandomBlackoutBlock=function(){var sequence=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,baseOptions={observePredictionPerBlock:16,block:0,blockType:"random",segmentLength:{A:[5,2,3,4,2],B:[2,3,4,5]},trialTypes:{o:"observation",oP:"observation_prediction",pBP:"post_blackout_prediction",blackout:"blackout"}};options=_lodash2.default.extend(baseOptions,options);var segAPermutations=(0,_experimentJs.samplePermutation)(options.segmentLength.A),segBPermutations=(0,_experimentJs.samplePermutation)(options.segmentLength.B),segmentSequence=[];segAPermutations.map(function(v,i){segmentSequence.push(segAPermutations[i]),i<segBPermutations.length&&segmentSequence.push(segBPermutations[i])});var blockSize=options.segmentLength.A.sum()+options.segmentLength.B.sum(),blackoutIndices=segmentSequence.integrate(),addPostBlackout=[],predictionIndices=_lodash2.default.range(0,blockSize).filter(function(v){return-1===blackoutIndices.indexOf(v)&&(-1===blackoutIndices.indexOf(v-1)||(addPostBlackout.push(v),!1))});predictionIndices=(0,_experimentJs.samplePermutation)(predictionIndices).slice(0,options.observePredictionPerBlock);for(var fullSequence=sequence.slice(),fullBlockType=(0,_experimentJs.rep)(options.blockType,blockSize),fullBlock=(0,_experimentJs.rep)(options.block,blockSize),fullTrial=_lodash2.default.range(1,blockSize+1),fullTrialType=[],i=0;i<sequence.length;i++)-1!==predictionIndices.indexOf(i)?fullTrialType.push(options.trialTypes.oP):-1!==addPostBlackout.indexOf(i)?fullTrialType.push(options.trialTypes.pBP):-1!==blackoutIndices.indexOf(i)?fullTrialType.push(options.trialTypes.blackout):fullTrialType.push(options.trialTypes.o);return{fullSequence:fullSequence,blockType:fullBlockType,block:fullBlock,trial:fullTrial,trialType:fullTrialType}},promiseFullSequenceForIntermitentPrediction=function(){var transitionMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return transitionMatrix=getValidTransitionArray(transitionMatrix),new Promise(function(resolve){var baseOptions={sequenceLength:180,sequenceALength:96,sequenceBLength:84,observePredictionPerBlock:16,errorThreshold:.06,numberOfNewTransitions:4,maxLoop:100,segmentLength:{A:[5,2,3,4,2],B:[2,3,4,5]},protectFirstBlock:!0,trialTypes:{o:"observation",oP:"observation_prediction",pBP:"post_blackout_prediction",blackout:"blackout"}};options=_lodash2.default.extend(baseOptions,options);var sequenceA=void 0,sequenceB=void 0;return options.sequenceLength=options.sequenceALength,promiseSequenceFromTransitionMatrix(transitionMatrix,options).then(function(result){var resultObject=getObservedAndDistanceMatrix(result,transitionMatrix),distanceMatrix=resultObject.distanceMatrix;return(0,_experimentJs.debugWarn)("promiseFullSequenceForIntermitentPrediction.sequenceA",_experimentMathjs2.default.sum(_experimentMathjs2.default.abs(distanceMatrix))),sequenceA=result,options.sequenceLength=options.sequenceBLength,promiseSequenceFromTransitionMatrix(transitionMatrix,options)}).then(function(result){var resultObject=getObservedAndDistanceMatrix(result,transitionMatrix),distanceMatrix=resultObject.distanceMatrix;(0,_experimentJs.debugWarn)("promiseFullSequenceForIntermitentPrediction.sequenceB",_experimentMathjs2.default.sum(_experimentMathjs2.default.abs(distanceMatrix))),sequenceB=_lodash2.default.clone(result);for(var currentBlock=-1,currentTrial=0,segAIndex=0,indicesBlackout=[],fullSequence=[],fullTrialType=[],fullTrial=[],fullBlock=[],segmentsA=_lodash2.default.clone(options.segmentLength.A),segmentsB=_lodash2.default.clone(options.segmentLength.B),lenghtBlockA=segmentsA.sum(),blockLength=lenghtBlockA+segmentsB.sum(),lenghtSegmentB=(0,_experimentJs.samplePermutation)(segmentsB),i=0;i<sequenceA.length;i++){var tempBlock=Math.floor(i/lenghtBlockA);if(tempBlock!==currentBlock)if(segmentsA=_lodash2.default.clone(options.segmentLength.A),segmentsB=_lodash2.default.clone(options.segmentLength.B),currentBlock=tempBlock,currentTrial=0,segAIndex=0,0===currentBlock&&options.protectFirstBlock){var first=segmentsA.shift();segmentsA[0]+=first,indicesBlackout=segmentsA.integrate(),lenghtSegmentB=(0,_experimentJs.samplePermutation)(segmentsB),first=lenghtSegmentB.shift(),lenghtSegmentB[0]+=first}else indicesBlackout=(0,_experimentJs.samplePermutation)(segmentsA).integrate(),lenghtSegmentB=(0,_experimentJs.samplePermutation)(segmentsB);if(fullTrial.push(currentTrial),fullSequence.push(sequenceA[i]),fullBlock.push(currentBlock),segAIndex+=1,currentTrial+=1,segAIndex!==lenghtBlockA&&-1!==indicesBlackout.indexOf(segAIndex)){fullTrialType.push(options.trialTypes.blackout);var addedSegmentLenght=lenghtSegmentB.shift(),addedSegment=sequenceB.splice(0,addedSegmentLenght),addTrials=_lodash2.default.range(currentTrial,currentTrial+addedSegmentLenght),addedTrialType=(0,_experimentJs.rep)(options.trialTypes.o,addedSegmentLenght);addedTrialType[0]=options.trialTypes.pBP;var addedBlock=(0,_experimentJs.rep)(currentBlock,addedSegmentLenght);fullSequence=fullSequence.concat(addedSegment),fullTrial=fullTrial.concat(addTrials),fullTrialType=fullTrialType.concat(addedTrialType),fullBlock=fullBlock.concat(addedBlock),currentTrial+=addedSegment.length}else fullTrialType.push(options.trialTypes.o)}for(var nblocks=Math.floor(fullSequence.length/blockLength),_i6=0;_i6<nblocks;_i6++)for(var blockTrialType=fullTrialType.slice(_i6*blockLength,(_i6+1)*blockLength),indicesPrediction=(0,_experimentJs.samplePermutation)(blockTrialType.indicesOf(options.trialTypes.o)).slice(0,options.observePredictionPerBlock),j=0;j<indicesPrediction.length;j++){var index=_i6*(blockLength+indicesPrediction[j]);fullTrialType[index]=options.trialTypes.oP}resolve({fullSequence:fullSequence,trial:fullTrial,trialType:fullTrialType,block:fullBlock,blockType:(0,_experimentJs.rep)("normal",fullSequence.length)})})})},promiseFullSequenceForOneLevel=function(){var transitionMatrix=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise(function(resolve){transitionMatrix=getValidTransitionArray(transitionMatrix);var numberOfStates=_experimentMathjs2.default.size(transitionMatrix)[0],baseOptions={numberOfSequences:8,insertRandomBlocksAt:[2,6],randomBlocksDominantStates:[2,2],randomBlocksDominantStateProbability:.4};options=_lodash2.default.extend(baseOptions,options);var randomBlocksNonDominantProbability=(1-options.randomBlocksDominantStateProbability)/(numberOfStates-1),randomTransitionMatrix=getRandomTransitionMatrix((0,_experimentJs.rep)(randomBlocksNonDominantProbability,numberOfStates));randomTransitionMatrix[options.randomBlocksDominantStates]=options.randomBlocksDominantStateProbability;for(var randomBlocksDominantState=(0,_experimentJs.matrix)(options.randomBlocksDominantStates.length,numberOfStates,0),randomBlocksNonDominantStates=(0,_experimentJs.matrix)(options.randomBlocksDominantStates.length,numberOfStates,(0,_experimentJs.rep)(0,numberOfStates-1)),i=0;i<options.randomBlocksDominantStates.length;i++)!function(i){for(var j=0;j<numberOfStates;j++)randomBlocksDominantState[i][j]=options.randomBlocksDominantStates[i],randomBlocksNonDominantStates[i][j]=_lodash2.default.range(0,numberOfStates).filter(function(v){return v!==options.randomBlocksDominantStates[i]})}(i);var dominantMatrix=getDominantCellByRow(transitionMatrix),dominantTransition=[],nonDominantTransitions=[];_lodash2.default.forEach(dominantMatrix,function(value,index){dominantTransition[index]=vectorToPosition(value),nonDominantTransitions[index]=_lodash2.default.range(0,dominantMatrix.length).filter(function(v){return v!==index&&v!==dominantTransition[index]})}),promiseSegmentsAndProbesByBlock(options).then(function(segments){var numberOfRandomBlocks=options.insertRandomBlocksAt.constructor===Array?options.insertRandomBlocksAt.length:0;promiseMultipleSequences(randomTransitionMatrix,{numberOfSequences:numberOfRandomBlocks,sequenceLength:segments.numberOfObservationPerBlock}).then(function(randomSequences){promiseMultipleSequences(transitionMatrix,{numberOfSequences:options.numberOfSequences-numberOfRandomBlocks,sequenceLength:segments.numberOfObservationPerBlock}).then(function(smoothedSequences){var numberOfBlocks=segments.block.uniqueValues().length;if(smoothedSequences.length>numberOfBlocks){for(var observedData=[],errors=[],kls=[],sequenceObjects=[],bestError=null,i=0;i<_smoothedSequences.length;i++)observedData[i]=getObservedAndDistanceMatrix(_smoothedSequences[i],transitionMatrix),errors[i]=observedData[i].totalError,kls[i]=matrixKlDivergence(observedData[i].observedMatrix,transitionMatrix),sequenceObjects.push({sequence:_smoothedSequences[i],error:errors[i]}),(null===bestError||errors[i]<bestError)&&(_smoothedSequences[i],bestError=errors[i]);console.warn(_lodash2.default.sortBy(errors));var _smoothedSequences=_lodash2.default.sortBy(sequenceObjects,"error").map(function(o){return o.sequence})}(0,_experimentJs.debuglog)(segments);for(var blocksNumber=segments.block.uniqueValues(),fullSequenceBlock=[],fullSequenceBlockType=[],completeSequence=[],trialType=[],trials=[],smoothedSequencesIndex=0,randomSequencesIndex=0,sequence=void 0,block=void 0,blockIndices=void 0,probeTransitions=void 0,blockType=void 0,nonDominantIndices=void 0,currentDominantTransitions=void 0,currentNonDominantTransitions=void 0,_i7=0;_i7<blocksNumber.length;_i7++)!function(_i7){-1!==options.insertRandomBlocksAt.indexOf(_i7)?(sequence=randomSequences[randomSequencesIndex],currentDominantTransitions=randomBlocksDominantState[randomSequencesIndex],currentNonDominantTransitions=randomBlocksNonDominantStates[randomSequencesIndex],blockType="random",randomSequencesIndex+=1):(sequence=smoothedSequences[smoothedSequencesIndex],currentDominantTransitions=dominantTransition,currentNonDominantTransitions=nonDominantTransitions,blockType="normal",smoothedSequencesIndex+=1),block=blocksNumber[_i7],blockIndices=segments.block.indicesOf(block);_lodash2.default.clone(segments.segmentSizeSequences).filter(function(value,index){return-1!==blockIndices.indexOf(index)});probeTransitions=[],nonDominantIndices=[_lodash2.default.random(0,1),_lodash2.default.random(0,1),_lodash2.default.random(0,1),_lodash2.default.random(0,1)];for(var probeSequenceRemaining=_lodash2.default.clone(segments.probeSequences).filter(function(value,index){return-1!==blockIndices.indexOf(index)&&(1===segments.transitionTypes[index]?probeTransitions.push(currentDominantTransitions[value]):(probeTransitions.push(currentNonDominantTransitions[value][nonDominantIndices[value]]),nonDominantIndices[value]+=1,nonDominantIndices[value]>=currentNonDominantTransitions[value].length&&(nonDominantIndices[value]=0)),!0)}),currentObservationIndex=0,lastTrial=0,j=0;j<blockIndices.length;j++){var segmentIndex=blockIndices[j],endIndex=currentObservationIndex+segments.segmentSizeSequences[segmentIndex];if(endIndex>sequence.length)throw new Error("StateManager.getFullSequenceForBlock: sequence length is not equal to the total number of observation generated by segment for block");var segment=sequence.slice(currentObservationIndex,endIndex);completeSequence=completeSequence.concat(segment),trialType=trialType.concat((0,_experimentJs.rep)("learning",segment.length)),currentObservationIndex=endIndex;var probePosition=probeSequenceRemaining[j],feedback=probeTransitions[j];completeSequence=completeSequence.concat(probePosition).concat(feedback),trialType=trialType.concat(["probe","feedback"]),fullSequenceBlock=fullSequenceBlock.concat((0,_experimentJs.rep)(block,segment.length+2)),fullSequenceBlockType=fullSequenceBlockType.concat((0,_experimentJs.rep)(blockType,segment.length+2));var N=segment.length+2,addTrials=Array.apply(void 0,_toConsumableArray(new Array(N))).map(function(_,i){return i+lastTrial+1});lastTrial=addTrials[addTrials.length-1],trials=trials.concat(addTrials)}}(_i7);resolve({fullSequence:completeSequence,trialType:trialType,block:fullSequenceBlock,blockType:fullSequenceBlockType,trial:trials})})})})})},getFullSequenceObjectForClassicLevels=function(sequence){var options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},baseOptions={trialType:"classic",blockType:"normal",block:0};options=_lodash2.default.extend(baseOptions,options);var t=0;return{fullSequence:sequence,block:(0,_experimentJs.rep)([options.block],sequence.length),blockType:(0,_experimentJs.rep)([options.blockType],sequence.length),trialType:(0,_experimentJs.rep)([options.trialType],sequence.length),trial:(0,_experimentJs.rep)([0],sequence.length).map(function(){return t+=1})}},insertSequenceObjectAtBlock=function(){var baseObject=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),insertedObject=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)(),atBlocks=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,_experimentJs.mandatory)(),newObject={fullSequence:[],block:[],trial:[],trialType:[],blockType:[]};atBlocks.constructor===Number&&(atBlocks=[atBlocks]);for(var offset=0,currentBlock=baseObject.block[0],baseCurrentBlock=currentBlock,i=0;i<baseObject.block.length;i++)!function(i){if(-1!==atBlocks.indexOf(baseObject.block[i])){atBlocks=atBlocks.filter(function(v){return v!==baseObject.block[i]});var _insertedBlock=insertedObject.block[offset];for(0!==baseObject.block[i]&&(currentBlock+=1);insertedObject.block[offset]===_insertedBlock;)newObject.fullSequence.push(insertedObject.fullSequence[offset]),newObject.block.push(currentBlock),newObject.trial.push(insertedObject.trial[offset]),newObject.trialType.push(insertedObject.trialType[offset]),newObject.blockType.push(insertedObject.blockType[offset]),offset+=1}baseObject.block[i]!==baseCurrentBlock&&(currentBlock+=1,baseCurrentBlock=baseObject.block[i]),newObject.fullSequence.push(baseObject.fullSequence[i]),newObject.block.push(currentBlock),newObject.trial.push(baseObject.trial[i]),newObject.trialType.push(baseObject.trialType[i]),newObject.blockType.push(baseObject.blockType[i])}(i);if(-1!==atBlocks.indexOf(baseObject.block.max()+1)&&offset<insertedObject.block.length)for(var insertedBlock=-1;offset<insertedObject.block.length;)insertedBlock!==insertedObject.block[offset]&&(currentBlock+=1,insertedBlock=insertedObject.block[offset]),newObject.fullSequence.push(insertedObject.fullSequence[offset]),newObject.block.push(currentBlock),newObject.trial.push(insertedObject.trial[offset]),newObject.trialType.push(insertedObject.trialType[offset]),newObject.blockType.push(insertedObject.blockType[offset]),offset+=1;return newObject},promiseBestSequencesForAllBlocksAndSave=function(){},getDensity=function(elements){var nsteps=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(elements.some(isNaN))throw new Error("TaskObject.getDensity: elements are not all numeric.");for(var range=[_experimentMathjs2.default.min(elements),_experimentMathjs2.default.max(elements)],stepSize=(range[1]-range[0])/nsteps,elementsInWindow=[],windowPosition=[],density=[],points=[],i=0;i<nsteps;i++)!function(i){var subset=_lodash2.default.filter(elements,function(e){var centered=e-range[0]-i*stepSize;return centered>=0&&centered<stepSize});windowPosition[i]=(i+.5)*stepSize,elementsInWindow[i]=subset.length,density[i]=elementsInWindow[i]/elements.length,points[i]={x:windowPosition[i],y:density[i]}}(i);return{windows:{position:windowPosition,numberOfElements:elementsInWindow,density:density},points:points,chartOptions:{type:"line",data:{datasets:[{label:"Density",data:points}]},options:{scales:{xAxes:[{type:"linear",position:"bottom"}]}}}}},randomColor=function(opacity){return"rgba("+Math.round(255*Math.random())+","+Math.round(255*Math.random())+","+Math.round(255*Math.random())+","+(opacity||".3")+")"},computeDurationEstimate=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},parametersBase={dominantProbability:.76,minNumberOfObservationsPerLearning:3,maxNumberOfObservationsPerLearning:7,observationDuration:500,interObservationDuration:50,minTimeToPredict:2e3,maxTimeToPredict:5e3,feedbackDuration:500,minISIAfterLearning:1e3,maxISIAfterLearning:1500,minISIAfterFeedback:3e3,maxISIAfterFeedback:5e3,rabbitAutoTransition:!1,rabbitDominantProbability:.6,observationSegmentSizes:[3,4,5],observationSegmentRepetitionPerBlock:2,numberOfBlocks:6,numberOfRandomBlocks:2,feedbackType:"transition"};options=_lodash2.default.extend(parametersBase,options);var numberOfObservationPerLevel=_experimentMathjs2.default.sum(options.observationSegmentSizes)*options.observationSegmentRepetitionPerBlock,oneObservationDuration=options.observationDuration,observationsDurationPerBlock=numberOfObservationPerLevel*oneObservationDuration,numberOfPredictionEventsPerBlock=options.observationSegmentSizes.length*options.observationSegmentRepetitionPerBlock,timeDurationMatrix=_experimentMathjs2.default.matrix([[options.minISIAfterLearning,options.maxISIAfterLearning],[options.minTimeToPredict,options.maxTimeToPredict],[options.feedbackDuration,options.feedbackDuration],[options.maxISIAfterFeedback,options.maxISIAfterFeedback]]),factorMatrix=_experimentMathjs2.default.matrix([[1,0,.5],[0,1,.5]]),predictionDurationMatrix=_experimentMathjs2.default.multiply(timeDurationMatrix,factorMatrix),sumPredictionDurationVector=_experimentMathjs2.default.multiply(_experimentMathjs2.default.matrix([1,1,1,1]),predictionDurationMatrix),predictionsDurationPerBlock=_experimentMathjs2.default.multiply(sumPredictionDurationVector,numberOfPredictionEventsPerBlock),observationDurationMatrix=_experimentMathjs2.default.matrix((0,_experimentJs.rep)(observationsDurationPerBlock,3)),durationPerBlock=_experimentMathjs2.default.add(observationDurationMatrix,predictionsDurationPerBlock),totalDuration=_experimentMathjs2.default.multiply(durationPerBlock,options.numberOfBlocks+options.numberOfRandomBlocks).toArray();return{min:totalDuration[0],max:totalDuration[1],mean:totalDuration[2]}},softMaxByRow=function(){for(var model=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),temperature=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.2,proportionArray=[],sumRow=[],i=0;i<model.length;i++)if(model[i].constructor===Array){sumRow[i]=_experimentMathjs2.default.sum(_experimentMathjs2.default.exp(_experimentMathjs2.default.divide(model[i],temperature))),proportionArray[i]=[];for(var j=0;j<model[i].length;j++)proportionArray[i][j]=_experimentMathjs2.default.exp(model[i][j]/temperature)/sumRow[i]}else sumRow[i]=_experimentMathjs2.default.sum(_experimentMathjs2.default.exp(_experimentMathjs2.default.divide(model,temperature))),proportionArray[i]=_experimentMathjs2.default.exp(model[i]/temperature)/sumRow[i];return proportionArray},prediction=function(){var model=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),position=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)(),options=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};model=getValidTransitionArray(model);var modelProportions=void 0,optionsBase={algorithm:"SOFTMAX",temperature:2};return options=_lodash2.default.extend(optionsBase,options),modelProportions="SOFTMAX"===options.algorithm?softMaxByRow(model):"MAX"===options.algorithm?getDominantCellByRow(getProportionArray(model)):getProportionArray(model),sampleNextTransition(modelProportions,position)},learnerPredict=function(){var sequence=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},optionsBase={learnerType:"structural",rules:["mainTransitionOut","mainTransitionIn"],offset:.01,learningRate:.2,temperature:2,trueModel:null,trialType:null,algorithm:"SOFTMAX"};if(options=_lodash2.default.extend(optionsBase,options),options.offset>1||options.offset<0)throw new Error("TaskObject.learnerPredict: offset needs to be between 0 and 1.");var algorithm=options.algorithm;if(-1===["SOFTMAX","MAX","PROPORTIONAL"].indexOf(algorithm))throw new Error("TaskObject.learnerPredict: algorithm is of invalid type (SOFTMAX, MAX or PROPORTIONAL).");if(-1!==options.rules.indexOf("dominantStructure")&&null===options.trueModel)throw new Error("TaskObject.learnerPredict: using the dominantStructure rule necessitate options.trueModel to be set.");if(null!==options.trialType){if(options.trialType.constructor!==Array)throw new Error("TaskObject.learnerPredict: options.trialType should be an array or null");if(options.trialType.length!==sequence.length)throw new Error("TaskObject.learnerPredict: options.trialType should be of same length")}var observedMatrix=(0,_experimentJs.matrix)(4,4,0),model=(0,_experimentJs.matrix)(4,4,options.offset),predictions=[],optimalPredictions=[],sameAsOptimal=[],sameAsOptimalProbability=[],sameAsSequence=[],sameAsSequenceProbability=[];"structural"===options.learnerType&&-1!==options.rules.indexOf("noSelf")&&(0,_experimentJs.diag)(model,0);_loop8:for(var i=0;i<sequence.length;i++){var _ret7=function(i){var currentPosition=sequence[i],predictionPosition=prediction(model,currentPosition,{algorithm:algorithm});predictions.push(predictionPosition);var dominantArray=null;if(null!==options.trueModel){dominantArray=getDominantCellByRow(options.trueModel);var optimalPrediction=sampleNextTransition(dominantArray,currentPosition);optimalPredictions.push(optimalPrediction),sameAsOptimal.push(optimalPrediction===predictionPosition?1:0),sameAsOptimalProbability.push(model[currentPosition][optimalPrediction])}if(i===sequence.length-1)return"break";if(null!==options.trialType){if("probe"===options.trialType[i+1]||"feedback"===options.trialType[i])return sameAsSequence.push(null),sameAsSequenceProbability.push(null),"continue";sameAsSequence.push(predictionPosition===sequence[i+1]?1:0),sameAsSequenceProbability.push(model[currentPosition][sequence[i+1]])}var targetPosition=sequence[i+1];switch(observedMatrix[currentPosition][targetPosition]+=1,console.warn(""+currentPosition+sequence[i+1]),options.learnerType){case"structural":if(-1!==options.rules.indexOf("dominantStructure"))!function(){var dominant=!1;1===dominantArray[currentPosition][targetPosition]&&(dominant=!0);for(var positionIndex=0;positionIndex<model.length;positionIndex++)!function(positionIndex){model[positionIndex]=_lodash2.default.map(model[positionIndex],function(value,index){return dominant&&1===dominantArray[positionIndex][index]?value+options.learningRate*(1-value)/4:dominant||1===dominantArray[positionIndex][index]?value:value+options.learningRate*(1-value)/12})}(positionIndex)}();else if(-1!==options.rules.indexOf("mainTransitionOut")&&(model[currentPosition]=_lodash2.default.map(model[currentPosition],function(value,index){return index!==targetPosition?value*(1-options.learningRate):value+options.learningRate*(1-value)})),-1!==options.rules.indexOf("mainTransitionIn"))for(var positionIndex=0;positionIndex<model.length;positionIndex++)positionIndex!==currentPosition&&positionIndex!==targetPosition&&(model[positionIndex][targetPosition]*=1-options.learningRate);break;case"nonStructural":var value=model[currentPosition][targetPosition];model[currentPosition][targetPosition]=value+options.learningRate*(1-value);break;default:throw new Error("TaskObject.learnerPredict: invalid learner type "+options.learnerType)}}(i);switch(_ret7){case"break":break _loop8;case"continue":continue}}var modelProportions=getProportionArray(model),returnObject={finalModel:modelProportions,predictions:predictions,sameAsSequence:sameAsSequence,sameAsSequenceProbability:sameAsSequenceProbability};return optimalPredictions.length>0&&(returnObject.optimalPredictions=optimalPredictions,returnObject.sameAsOptimal=sameAsOptimal,returnObject.sameAsOptimalProbability=sameAsOptimalProbability),returnObject},updateWithRule=function(){var rule=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)(),arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,_experimentJs.mandatory)());arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,_experimentJs.mandatory)();switch(rule){case"mainTransitionOut":case"mainTransitionIn":case"noSelf":case"noSquare":case"noBack":case"all":break;default:throw new Error("taskObject.updateWithRule: invalid rule")}},sampleExponential=function(){var mean=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,min=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,max=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,jitter=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,pWindow=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[.001,.999],p=_experimentMathjs2.default.random(pWindow[0],pWindow[1]),lambda=1/mean;jitter=null===jitter?.05*mean:jitter;var sample=-Math.log(1-p)/lambda;return sample=null===min?sample:Math.max(sample,min+Math.random()*jitter),sample=null===max?sample:Math.min(sample,max-Math.random()*jitter)};exports.sampleExponential=sampleExponential,exports.softMaxByRow=softMaxByRow,exports.prediction=prediction,exports.updateWithRule=updateWithRule,exports.learnerPredict=learnerPredict,exports.computeDurationEstimate=computeDurationEstimate,exports.randomColor=randomColor,exports.getDensity=getDensity,exports.promiseBestSequencesForAllBlocksAndSave=promiseBestSequencesForAllBlocksAndSave,exports.insertSequenceObjectAtBlock=insertSequenceObjectAtBlock,exports.getFullSequenceObjectForClassicLevels=getFullSequenceObjectForClassicLevels,exports.promiseFullSequenceForOneLevel=promiseFullSequenceForOneLevel,exports.promiseFullSequenceForIntermitentPrediction=promiseFullSequenceForIntermitentPrediction,exports.getFullSequenceObjectForRandomBlackoutBlock=getFullSequenceObjectForRandomBlackoutBlock,exports.promiseSegmentsAndProbesByBlock=promiseSegmentsAndProbesByBlock,exports.promiseMultipleRandomSequences=promiseMultipleRandomSequences,exports.promiseMultipleSequences=promiseMultipleSequences,exports.promiseSequenceFromTransitionMatrix=promiseSequenceFromTransitionMatrix,exports.smoothSequenceDistribution=smoothSequenceDistribution,exports.getObservedAndDistanceMatrix=getObservedAndDistanceMatrix,exports.getObservedArrays=getObservedArrays,exports.matrixKlDivergence=matrixKlDivergence,exports.getDominantProbabilityByRow=getDominantProbabilityByRow,exports.getDominantCellByRow=getDominantCellByRow,exports.getValidTransitionArray=getValidTransitionArray,exports.sampleNextTransition=sampleNextTransition,exports.sampleTransitions=sampleTransitions,exports.vectorToPosition=vectorToPosition,exports.positionToVector=positionToVector,exports.getZeroOrderTransitionMatrix=getZeroOrderTransitionMatrix,exports.getRandomTransitionMatrix=getRandomTransitionMatrix,exports.getTransitionMatrixFromBase=getTransitionMatrixFromBase,exports.computeValidStateSpace=computeValidStateSpace,exports.getBaseGraphMatrices=getBaseGraphMatrices,exports.getAspectRatio=getAspectRatio},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_4__},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkIdleAndConnection=exports.showAll=exports.hideAll=exports.setBlackScreen=exports.setAgentOpacity=exports.getAgentPositionOnTile=exports.animateAgentToTile=exports.moveAgentToTile=exports.setMargins=exports.setAgent=exports.getAgentMarginsOnTile=exports.drawPredictionTiles=exports.highlightPosition=exports.getTileSize=exports.getTileMargins=exports.getTilePositions=exports.clearTiles=exports.disposeOfButtons=exports.addButton=exports.drawTiles=exports.redrawAssets=void 0;var _lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_taskUtilities=__webpack_require__(3),redrawAssets=function(){var rabbitFaceTexture=this.taskObject.cloneAssetIntoScene(this.R.get.rabbitFace,this.scene),wolfFaceTexture=this.taskObject.cloneAssetIntoScene(this.R.get.wolfFace,this.scene),crossSheet=this.taskObject.cloneAssetIntoScene(this.R.get.crossSheet,this.scene),scene=this.scene;wolfFaceTexture.hasAlpha=!0,rabbitFaceTexture.hasAlpha=!0,crossSheet.hasAlpha=!0;var elements2D=this.stateManager.get("elements2D"),canvasOptions={id:"initialCanvas",parent:scene.initialCanvas.parent,roundRadius:scene.initialCanvas.roundRadius,borderThickness:0,fill:scene.initialCanvas.fill,position:new _experimentBabylonJs2.default.Vector2(0,0),size:this.taskObject.renderSize,zOrder:1},initialCanvas=new _experimentBabylonJs2.default.Rectangle2D(canvasOptions);scene.initialCanvas.dispose(),scene.initialCanvas=initialCanvas,scene.initialCanvas.lastResize=this.taskObject.timeInMs;var crossSprite=this.R.get.cross_predict,crossOpacity=0,loaderOpacity=1,loaderValue=0,wolfOpacity=0,rabbitOpacity=0,agentType="wolf",tiles=[];if(null!==elements2D){if(elements2D.canvas=scene.initialCanvas,crossOpacity=elements2D.cross.opacity,crossSprite=elements2D.cross.spriteFrame,elements2D.cross.levelVisible=!1,wolfOpacity=elements2D.wolfFaceSprite.opacity,elements2D.wolfFaceSprite.levelVisible=!1,rabbitOpacity=elements2D.rabbitFaceSprite.opacity,elements2D.rabbitFaceSprite.levelVisible=!1,agentType=elements2D.agentType,loaderOpacity=elements2D.loader.opacity,loaderValue=elements2D.loader.value,elements2D.loader.levelVisible=!1,elements2D.tiles&&elements2D.tiles.length&&"levelVisible"in elements2D.tiles[0]){var levelV=elements2D.tiles[0].levelVisible,options={};(0,_experimentJs.hasConstructor)(_experimentJs.Array,elements2D.keysInfobox)&&(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Rectangle2D,elements2D.keysInfobox[0])&&elements2D.keysInfobox[0].levelVisible&&(options={withKeys:"dkmc"}),this.stateManager.call("drawTiles",options),elements2D.tiles.forEach(function(e){e.levelVisible=levelV})}tiles=elements2D.tiles}var cross=new _experimentBabylonJs2.default.Sprite2D(crossSheet,{parent:this.scene.initialCanvas,id:"cross",marginAlignment:"v: center, h: center",spriteSize:new _experimentBabylonJs2.default.Size(20,20),spriteLocation:new _experimentBabylonJs2.default.Vector2(0,0)});cross.spriteFrame=crossSprite,cross.opacity=crossOpacity;var loader=new _experimentJs.Loader({parent:this.scene.initialCanvas,size:new _experimentBabylonJs2.default.Size(25,25),border:_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(.7,.7,.7,1)),borderThickness:2});loader.value=loaderValue,loader.opacity=loaderOpacity,loader.margin.leftPixels=1,loader.margin.rightPixels=0,loader.margin.topPixels=0,loader.margin.bottomPixels=.5;var minSize=Math.min(this.taskObject.renderSize.width,this.taskObject.renderSize.height),wolfFaceSprite=new _experimentBabylonJs2.default.Sprite2D(wolfFaceTexture,{parent:this.scene.initialCanvas,id:"wolfFaceSprite",origin:_experimentBabylonJs2.default.Vector2.Zero(),marginAlignment:"v: center, h: center",zOrder:1,size:new _experimentBabylonJs2.default.Size(minSize*this.R.get.agent_scale,minSize*this.R.get.agent_scale/(0,_taskUtilities.getAspectRatio)(wolfFaceTexture))});wolfFaceSprite.opacity=wolfOpacity;var rabbitFaceSprite=new _experimentBabylonJs2.default.Sprite2D(rabbitFaceTexture,{parent:this.scene.initialCanvas,id:"rabbitFaceSprite",origin:_experimentBabylonJs2.default.Vector2.Zero(),marginAlignment:"v: center, h: center",size:new _experimentBabylonJs2.default.Size(minSize*this.R.get.agent_scale,minSize*this.R.get.agent_scale/(0,_taskUtilities.getAspectRatio)(rabbitFaceTexture)),zOrder:1});rabbitFaceSprite.opacity=rabbitOpacity;var agent="wolf"===agentType?wolfFaceSprite:rabbitFaceSprite;elements2D={canvas:scene.initialCanvas,cross:cross,wolfFaceSprite:wolfFaceSprite,rabbitFaceSprite:rabbitFaceSprite,agent:agent,agentType:"wolf",tiles:tiles,loader:loader},this.stateManager.setGlobal("elements2D",elements2D),this.stateManager.call("moveAgentToTile",{tile:this.stateManager.get("lastMove",1)})},clearTiles=function(){if(void 0===this.taskObject)throw new Error("stateManager.clearTiles: this.taskObject is undefined");var stateManager=this.stateManager,elements2D=stateManager.get("elements2D"),canvas=elements2D.canvas;if(elements2D.tiles.length>0){for(var ntile=elements2D.tiles.length,j=0;j<ntile;j++)elements2D.tiles[j].dispose();elements2D.tiles=[];for(var i=0;i<ntile;i++){elements2D.tiles[i]=new _experimentBabylonJs2.default.Rectangle2D({parent:canvas,id:"tile"+i,position:new _experimentBabylonJs2.default.Vector2(1,1),width:new _experimentBabylonJs2.default.Vector2(1,1),height:new _experimentBabylonJs2.default.Vector2(1,1),border:null,opacity:0,borderThickness:null,fill:_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(.8,.8,.8,0)),zOrder:.1})}(0,_experimentJs.debuglog)("stateManager.clearTiles: resolved")}else(0,_experimentJs.debugWarn)("stateManager.clearTiles: resolved - no tile to clear");return elements2D.tiles},addButton=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.taskObject)throw new Error("stateManager.addButton: this.taskObject is undefined");var stateManager=this.stateManager,canvas=stateManager.get("elements2D").canvas,baseOptions={id:"button"+stateManager.timeInMs,text:"text",x:50,y:50,width:100,height:50,fill:_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(.8,.8,.8,1)),clickEventData:null,fontName:"30pt Arial",baseOpacity:.8,hoverOpacity:1,zOrder:-.5,marginAlignment:null,fontSignedDistanceField:!0,margin:{},padding:{},parent:canvas};baseOptions.margin.leftPixels=0,baseOptions.margin.rightPixels=0,baseOptions.margin.topPixels=0,baseOptions.margin.bottomPixels=0,baseOptions.padding.leftPixels=0,baseOptions.padding.rightPixels=0,baseOptions.padding.topPixels=0,baseOptions.padding.bottomPixels=0,baseOptions.margin=_lodash2.default.extend(baseOptions.margin,options.margin),baseOptions.padding=_lodash2.default.extend(baseOptions.padding,options.padding),options.margin=baseOptions.margin,options.padding=baseOptions.padding,options=_lodash2.default.extend(baseOptions,options);var buttonOptions={},margin={},padding={};null===options.marginAlignment?buttonOptions={parent:options.parent,id:options.id,x:options.x,y:options.y,width:options.width,height:options.height,fill:options.fill,zOrder:options.zOrder,roundRadius:0,children:[new _experimentBabylonJs2.default.Text2D(options.text,{fontName:options.fontName,marginVAlignment:"v: center",fontSignedDistanceField:options.fontSignedDistanceField,marginHAlignment:3})]}:(buttonOptions={parent:options.parent,id:options.id,width:options.width,height:options.height,fill:options.fill,zOrder:options.zOrder,marginAlignment:options.marginAlignment,roundRadius:0,children:[new _experimentBabylonJs2.default.Text2D(options.text,{fontName:options.fontName,marginVAlignment:"v: center",fontSignedDistanceField:options.fontSignedDistanceField,marginHAlignment:3})]},margin=options.margin,padding=options.padding);var buttonRect=new _experimentBabylonJs2.default.Rectangle2D(buttonOptions);return buttonRect.opacity=options.baseOpacity,null!==margin&&(buttonRect.margin.rightPixels=options.margin.rightPixels,buttonRect.margin.leftPixels=options.margin.leftPixels,buttonRect.margin.topPixels=options.margin.topPixels,buttonRect.margin.bottomPixels=options.margin.bottomPixels),null!==padding&&(buttonRect.padding.rightPixels=padding.rightPixels,buttonRect.padding.leftPixels=padding.leftPixels,buttonRect.padding.topPixels=padding.topPixels,buttonRect.padding.bottomPixels=padding.bottomPixels),buttonRect.pointerEventObservable.add(function(){buttonRect.opacity=options.hoverOpacity},_experimentBabylonJs2.default.PrimitivePointerInfo.PointerOver),buttonRect.pointerEventObservable.add(function(){buttonRect.opacity=options.baseOpacity},_experimentBabylonJs2.default.PrimitivePointerInfo.PointerOut),null!==options.clickEventData&&options.clickEventData.constructor===_experimentJs.EventData&&buttonRect.pointerEventObservable.add(function(){options.clickEventData.happenedAt=stateManager.timeInMs,options.clickEventData.data.button=buttonRect.id,stateManager.addEvent(options.clickEventData)},_experimentBabylonJs2.default.PrimitivePointerInfo.PointerUp),buttonRect},disposeOfButtons=function(){var elements2D=this.stateManager.get("elements2D");if(void 0!==elements2D.levelButtons&&elements2D.levelButtons.constructor===_experimentJs.Array){for(var i=0;i<elements2D.levelButtons.length;i++)elements2D.levelButtons[i].dispose();elements2D.levelButtons=[]}return"disposeOfButtons: buttons disposed."},getTileSize=function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this.taskObject)return"stateManager.drawTiles: this.taskObject is undefined";var taskObject=this.taskObject,R=this.R,greaterLength=Math.min(taskObject.renderSize.width*R.get.agent_scale*R.get.tile_scale,taskObject.renderSize.height*R.get.agent_scale*R.get.tile_scale);return new _experimentBabylonJs2.default.Vector2(greaterLength,greaterLength)},setMargins=function(prim,margin){prim.margin.rightPixels=margin.rightPixels,prim.margin.leftPixels=margin.leftPixels,prim.margin.topPixels=margin.topPixels,prim.margin.bottomPixels=margin.bottomPixels},drawTiles=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.taskObject)return"stateManager.drawTiles: this.taskObject is undefined";var baseOptions={hightlight:-1,type:"learning",withKeys:!1,fontName:"14pt Verdana"};options=_lodash2.default.extend(baseOptions,options);var stateManager=this.stateManager,R=this.R,elements2D=stateManager.get("elements2D"),canvas=elements2D.canvas;elements2D.cross.opacity=R.get.cross_opacity,elements2D.keysInfoboxText&&elements2D.keysInfobox||(elements2D.keysInfobox=[],elements2D.keysInfoboxText=[]);var normalSize=stateManager.call("getTileSize"),tileMargins=stateManager.call("getTileMargins");(0,_experimentJs.hasConstructor)(_experimentJs.String,options.withKeys)&&4===options.withKeys.length||(options.withKeys=null);for(var normalColor=[.8,.8,.8,1],i=0;i<4;i++){(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Rectangle2D,elements2D.tiles[i])&&elements2D.tiles[i].dispose(),(0,_experimentJs.debuglog)("loop"+options.type),console.warn("NORMAL SIZE:",normalSize);var normalTile=new _experimentBabylonJs2.default.Rectangle2D({parent:canvas,id:"tile"+i,marginAlignment:"h: center, v: center",width:normalSize.x,height:normalSize.y,border:_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new(Function.prototype.bind.apply(_experimentBabylonJs2.default.Color4,[null].concat(normalColor)))),borderThickness:2,fill:null,zOrder:.1});elements2D.tiles[i]=normalTile,setMargins(elements2D.tiles[i],tileMargins[i]),(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Rectangle2D,elements2D.keysInfobox[i])&&!(0,_experimentJs.hasConstructor)(_experimentJs.String,options.withKeys)?elements2D.keysInfobox[i].levelVisible=!1:(0,_experimentJs.hasConstructor)(_experimentJs.String,options.withKeys)&&((0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Rectangle2D,elements2D.keysInfobox[i])&&elements2D.keysInfobox[i].dispose(),elements2D.keysInfobox[i]=new _experimentBabylonJs2.default.Rectangle2D({parent:elements2D.tiles[i],id:"keyInfoBackground"+i,width:50,height:50,marginAlignment:"h: center, v: top",fill:_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(.64,.64,.64,.5))}),elements2D.keysInfoboxText[i]=new _experimentBabylonJs2.default.Text2D(options.withKeys[i],{parent:elements2D.keysInfobox[i],fontName:options.fontName,marginAlignment:"h: center, v: center",fontSuperSample:!1,fontSignedDistanceField:!0}))}return elements2D.tiles},getTileMargins=function(){var stateManager=this.stateManager,R=this.R,canvas=stateManager.get("elements2D").canvas,tileSize=stateManager.call("getTileSize"),offset=R.get.tile_offset;if(void 0===canvas)throw new Error("StateManager.getTilePositions: canvas is undefined.");return[{leftPixels:0,topPixels:0,rightPixels:tileSize.x/2+offset,bottomPixels:tileSize.y/2+offset},{rightPixels:0,topPixels:0,leftPixels:tileSize.x/2+offset,bottomPixels:tileSize.y/2+offset},{rightPixels:0,bottomPixels:0,leftPixels:tileSize.x/2+offset,topPixels:tileSize.y/2+offset},{leftPixels:0,bottomPixels:0,rightPixels:tileSize.x/2+offset,topPixels:tileSize.y/2+offset}]},getTilePositions=function(){if(void 0===this.taskObject)throw new Error("stateManager.getTilePositions: this.taskObject is undefined");var stateManager=this.stateManager,R=this.R,canvas=stateManager.get("elements2D").canvas,tileSize=stateManager.call("getTileSize"),center={w:canvas.width/2,h:canvas.height/2},offset=R.get.tile_offset;if(void 0===canvas)throw new Error("StateManager.getTilePositions: canvas is undefined.");return[new _experimentBabylonJs2.default.Vector2(center.w-(tileSize.x/2+offset),center.h+(tileSize.y/2+offset)),new _experimentBabylonJs2.default.Vector2(center.w+(tileSize.x/2+offset),center.h+(tileSize.y/2+offset)),new _experimentBabylonJs2.default.Vector2(center.w+(tileSize.x/2+offset),center.h-(tileSize.y/2+offset)),new _experimentBabylonJs2.default.Vector2(center.w-(tileSize.x/2+offset),center.h-(tileSize.y/2+offset))]},highlightPosition=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("stateManager.highlightPosition: this.stateManager is undefined");if(void 0===options.position)throw new Error("stateManager.highlightPosition: options.position is undefined");return this.stateManager.promise("drawTiles",{hightlight:options.position,type:void 0!==options.type?options.type:"prediction"})},drawPredictionTiles=function(){var _ref=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{withKeys:!1},_ref$withKeys=_ref.withKeys,withKeys=void 0!==_ref$withKeys&&_ref$withKeys;if(void 0===this.taskObject)throw new Error("stateManager.drawPredictionTiles: this.taskObject is undefined");return this.stateManager.promise("drawTiles",{type:"prediction",withKeys:withKeys})},setAgent=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.taskObject)throw new Error("stateManager.drawPredictionTiles: this.taskObject is undefined");if(void 0===options.agent)throw new Error("stateManager.setAgent: options.agent is undefined");var stateManager=this.stateManager,elements2D=stateManager.get("elements2D"),currentMargin=elements2D.agent.margin;switch(elements2D.agent.opacity=0,options.agent){case"wolf":elements2D.agent=elements2D.wolfFaceSprite;break;case"rabbit":elements2D.agent=elements2D.rabbitFaceSprite;break;default:throw new Error("stateManager.setAgent: options.agent "+options.agent+" is of invalid type.")}return elements2D.agentType=options.agent,elements2D.agent.margin=currentMargin,elements2D.tiles[options.positions]},getAgentPositionOnTile=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("stateManager.drawPredictionTiles: stateManager is undefined");if(void 0===options.tile)throw new Error("stateManager.setAgent: tile is undefined");var stateManager=this.stateManager,elements2D=stateManager.get("elements2D"),agent=elements2D.agent,scaledAgentSize=new _experimentBabylonJs2.default.Vector2(agent.size.width,agent.size.height).scaleInPlace(agent.scale);return stateManager.call("getTilePositions")[options.tile].subtract(scaledAgentSize.scale(.5))},getAgentMarginsOnTile=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("stateManager.drawPredictionTiles: stateManager is undefined");if(void 0===options.tile)throw new Error("stateManager.setAgent: tile is undefined");var stateManager=this.stateManager,tileMargins=stateManager.call("getTileMargins")[options.tile];return{leftPixels:0===tileMargins.leftPixels?0:tileMargins.leftPixels+0,rightPixels:0===tileMargins.rightPixels?0:tileMargins.rightPixels+0,topPixels:0===tileMargins.topPixels?0:tileMargins.topPixels+0,bottomPixels:0===tileMargins.bottomPixels?0:tileMargins.bottomPixels+0}},moveAgentToTile=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("stateManager.drawPredictionTiles: stateManager is undefined");if(void 0===options.tile)throw new Error("stateManager.setAgent: tile is undefined");var elements2D=this.stateManager.get("elements2D"),agent=elements2D.agent;return agent.margin=_lodash2.default.extend(agent.margin,this.stateManager.call("getAgentMarginsOnTile",options)),this.stateManager.set("lastMove",options.tile),void 0!==options.opacity&&this.stateManager.call("setAgentOpacity",{opacity:options.opacity}),agent},animateAgentToTile=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("stateManager.drawPredictionTiles: stateManager is undefined");if(void 0===options.tile)throw new Error("stateManager.setAgent: tile is undefined");var elements2D=this.stateManager.get("elements2D"),agent=elements2D.agent,newPosition=this.stateManager.call("getAgentPositionOnTile",options);void 0!==options.opacity&&this.stateManager.call("setAgentOpacity",{opacity:options.opacity});var deferred=new _experimentJs.Deferred,animation=new _experimentBabylonJs2.default.Animation("slideToPosition","position",100,_experimentBabylonJs2.default.Animation.ANIMATIONTYPE_VECTOR2,_experimentBabylonJs2.default.Animation.ANIMATIONLOOPMODE_CONSTANT),keys=[];keys.push({frame:0,value:agent.position}),keys.push({frame:10,value:newPosition}),animation.setKeys(keys);var end=new _experimentBabylonJs2.default.AnimationEvent(10,function(){deferred.resolve()},!0);return animation.addEvent(end),agent.animations.push(animation),this.scene.beginAnimation(agent,0,11),deferred.promise},setAgentOpacity=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.stateManager)throw new Error("stateManager.drawPredictionTiles: this.stateManager is undefined");if(void 0===options.opacity)throw new Error("stateManager.setAgent: options.opacity is undefined");var elements2D=this.stateManager.get("elements2D"),agent=elements2D.agent;return agent.opacity=options.opacity,agent},setBlackScreen=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,baseOptions={on:!0};options=_lodash2.default.extend(baseOptions,options);var elements2D=this.stateManager.getGlobal("elements2D"),canvas=elements2D.canvas;if(!_lodash2.default.has(elements2D,"blackScreen")){var blackScreen=new _experimentBabylonJs2.default.Rectangle2D({parent:canvas,id:"blackScreen",position:new _experimentBabylonJs2.default.Vector2(0,0),width:canvas.size.width,height:canvas.size.height,zOrder:0});elements2D.blackScreen=blackScreen}options.on?elements2D.blackScreen.opacity=1:elements2D.blackScreen.opacity=0},hideAll=function(){var stateManager=this.stateManager,elements2D=stateManager.get("elements2D");elements2D.agent.levelVisible=!1,elements2D.cross.levelVisible=!1,elements2D.loader.levelVisible=!1,elements2D.tiles.forEach(function(t){t.levelVisible=!1})},showAll=function(){var stateManager=this.stateManager,elements2D=stateManager.get("elements2D");elements2D.agent.levelVisible=!0,elements2D.cross.levelVisible=!0,elements2D.loader.levelVisible=!0,elements2D.tiles.forEach(function(t){t.levelVisible=!0})},checkIdleAndConnection=function(){var _this=this,_ref2=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{deferred:new _experimentJs.Deferred,returnToState:null},_ref2$deferred=_ref2.deferred,deferred=void 0===_ref2$deferred?new _experimentJs.Deferred:_ref2$deferred,_ref2$returnToState=_ref2.returnToState,returnToState=void 0===_ref2$returnToState?null:_ref2$returnToState,stateManager=this.stateManager,R=this.R,dataManager=this.dataManager,connection=this.connection;return returnToState=returnToState||stateManager.currentStateKey,dataManager.query("getLastInteraction",null,connection,deferred),deferred.promise.then(function(r){var delay=stateManager.timeInMs-r.lastInteraction,delayMin=delay/6e4;delay>18e5?((0,_experimentJs.debugWarn)("running.goToNextPosition: idle for too long"),stateManager.set("endReason","You were idle for more than 30 min: "+delayMin+" min"),stateManager.goToState(R.get.states_end)):stateManager.currentStateKey!==returnToState&&stateManager.goToState(returnToState)}).catch(function(){(0,_experimentJs.debugWarn)("running.goToNextPosition: lost connection"),stateManager.currentStateKey!==R.get.states_idle&&(stateManager.call("hideAll"),stateManager.onNext(_this.R.get.events_unfrozen,function(){stateManager.call("showAll")}),_this.state.freeze(),stateManager.goToState(R.get.states_idle)),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:returnToState})})})};exports.redrawAssets=redrawAssets,exports.drawTiles=drawTiles,exports.addButton=addButton,exports.disposeOfButtons=disposeOfButtons,exports.clearTiles=clearTiles,exports.getTilePositions=getTilePositions,exports.getTileMargins=getTileMargins,exports.getTileSize=getTileSize,exports.highlightPosition=highlightPosition,exports.drawPredictionTiles=drawPredictionTiles,exports.getAgentMarginsOnTile=getAgentMarginsOnTile,exports.setAgent=setAgent,exports.setMargins=setMargins,exports.moveAgentToTile=moveAgentToTile,exports.animateAgentToTile=animateAgentToTile,exports.getAgentPositionOnTile=getAgentPositionOnTile,exports.setAgentOpacity=setAgentOpacity,exports.setBlackScreen=setBlackScreen,exports.hideAll=hideAll,exports.showAll=showAll,exports.checkIdleAndConnection=checkIdleAndConnection},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.tutorialUnfrozen=exports.tutorials=exports.awakeTutorial=exports.showModal=exports.showNextPage=void 0;var _experimentJs=__webpack_require__(0),_experimentBoxes=__webpack_require__(4),intro={title:{en:"Catch the wolf"},content:{en:"\n    <h5>Welcome !   </h5>\n    The members of Bavelier lab extend a warm welcome to you from Geneva! We are very grateful that you took interest in our experiment !<br>\n    This short tutorial will go over the mechanics of the task to make sure all is clear before you start !<br><br>\n    <h5>General description</h5>\n    The goal of the task is to look at how a wolf moves across four positions of the screen,\n    and predict where it is going to appear next using the keyboard.<br>\n    Each trial will be composed of an observation phase and most of the times a prediction phase.<br>\n    You will go through <b>four levels</b> of increasing difficulty.<br>\n    The task will last between <b>1 and 2 hours</b>  depending on the breaks you will take.<br><br>"}},disclaimer={title:{en:" IMPORTANT  "},content:{en:"<b>After you complete the four levels of the task you will receive your HIT code.</b>\n  Some behavior will lead to a premature stop of the task without possibility to pass it again:\n  <ul>\n    <li>Taking breaks over the allowed time limit: no breaks during levels and maximum 15min between levels</li>\n    <li>If you do not answer more than 5 times in a row or if the window is out of focus the game will pause for maximum 30sec per level before stopping</li>\n    <li>Loosing connection to the server for more than 15min*</li>\n    <li>Not answering on more than 20% of trials</li>\n    <li>Cheating or obvious behavior showing lack of engagement</li>\n  </ul>\n  A countdown will appear before the task is stopped to warn you (* except if you lose connection).<br>\n  If you accept those conditions please do proceed.  "}},trialInstruction={title:{en:"Observation and Prediction"},content:{en:"<h5>Observation phase</h5>\n    When a trial starts you will first observe the position of the wolf for a split second before he disapears,\n    then there is a short delay when you do not need to press any key.\n    During this phase the center square will be full:\n    <br>\n      <center><img src='./assets/sprites/cross/fullSquare.svg'></center>\n    <br><br>\n    <h5>Prediction phase</h5>\n    Then there will be a sudden modification of the cross at the center of\n    the screen, with dotted border:\n    <br>\n      <center><img src='./assets/sprites/cross/predictionSquare.svg'></center>\n    <br>\n\n    This modification marks the begining of the prediction phase. As soon as you see this open square you will have to predict\n    as fast as you can the next position of the wolf using the keyboard. After you have predicted, you will wait for a short while\n    until the wolf appears to his new position. Failling to answer 5 times in a row will pause the task.\n    <br>"}},fourLevels={title:{en:"Four levels"},content:{en:"\n    <h5>The levels</h5>\n    There will be <b>four levels</b> in this task, the first three levels are relatively short and will last around 10min each.\n    The fourth level is supposed to be passed in an MRI and will be slower, it will last for around 30min.\n    <br><br>\n    <h5>Breaks</h5>\n    You cannot pause the game during levels and if you open another page/program, or if you do not respond for too long the game will pause.\n    If the game is pause for more than 30sec total on a level the experiment will stop. <br>\n    Breaks are allowed between levels, but as it is the case in all experiments involving learning, long pauses may have a strong\n    and uncontrolled impact on your ability to learn and may affect our results in unpredictable ways. That is why we will allow for breaks no longer than 15 minutes.<br>\n    To complete the tasks it will take you between 1 and 2 hours depending on the length of the break you will take<br><br>"}},progressInstruction={title:{en:"Progress"},content:{en:'\n    During each level you will be able to evaluate your progress through the progress indicator around the central square,\n    as you progress the square will gradually get fuller:\n    <br><br>\n      <center><img width="20" height="20" src=\'./assets/sprites/cross/predictionSquareWithLoader.gif\'></center>\n    <br>'}},keyboardInstruction={title:{en:"Keyboard keys"},content:{en:'To complete this task you will use the keyboard only.\n    <br>\n    <center><img src="./assets/sprites/keyboard/fullsize_color_legend.png"></center>\n    <br>\n    The keys you will be using are :\n    <ul>\n      <li>D - to pick the top left position</li>\n      <li>C - to pick the bottom left position</li>\n      <li>K - to pick the top right position</li>\n      <li>M - to pick the bottom right position</li>\n      <li>Space bar - to pause and reach the menu</li>\n    </ul>\n    '}},introToTryout={title:{en:"Let's try!"},content:{en:"Ok. You will now try a short sequence of trials so you can familiarize yourself with the task.\n        <br>\n        Good luck, and thank you for your participation ! \n        <br><br>\n        The Bavelier Lab team\n        "}},correctPrediction={title:{en:"Correct !"},content:{en:"Well done, this prediction was correct ! <br>\n    No signal will explicitely tell you wether you were right or wrong. But if you see the wolf appear where you predicted,\n    it will count as a correct trial.\n        "}},incorrectPrediction={title:{en:"Incorrect !"},content:{en:"Well done, this prediction was correct ! <br>\n    No signal will explicitely tell you wether you were right or wrong. But if you see the wolf appear where you predicted,\n    it will count as a correct trial.\n        "}},askContinue={title:{en:"End tutrial ?"},content:{en:'Do you feel confident you understand the task ? <br>\n    If not you can restart the tutorial by clicking here: <button class="btn btn-secondary dragbox-button smartmodal-closebutton" onClick="window.taskObject.context.stateManager.newEvent(\'restartTutorial\')">Restart tutorial</button>\n    <br><br>\n      Please be aware that too much missing values (when you do not respond) makes our data unusable, cheating risk altering our results and might make us draw wrong conclusions.<br>\n      For this reason at the end of the task an algorithm will check the validity of the data.\n      If the data is not valid you will not receive the bonus payment for adequate completion and we will refrain from using your service in future studies.\n\n      <br><br>\n      If you feel confident, close the window to start the task !\n        '}},fmriIntro={title:{en:"Last Level"},content:{en:'\n      <h5>The next part will be slower</h5>\n      Thank you and congratulations for finishing the first three parts ! <br>\n      The next part is adapted for a future study in the lab where we will have to use an MRI machine to\n      image the brain of our subjects as they perform the task. Because of this, this next part will be slower.<br>\n      It is not a bug, and the goal remains the same: predict the next position correctly ! <br>\n      Because it is slower, the task is segmented in <b>three "blocks"</b> of 50 trials, between which you can take a short break of max 5 minutes.<br>\n      <br>\n      <h5>You will sometime have to catch a rabbit !</h5>\n      The rabbit does not behave like the wolf, it will be your job to find how to best predict its next position.<br>\n      You will go through a short tutorial so you can familliarize yourself with the rabbit.<br>\n      The rabbit will appear in the second block and you will have to predict its movement for 50 trials.'}},fmriDelay={title:{en:"New feature: delays"},content:{en:"A new change is that you will not predict right after observing the new position of the agent (wolf or rabbit).<br>\n    The agent will appear for a short time, then disapear. You will have to wait a short delay before predicting. <br>\n    As before the signal for you to hit the keyboard will be given by the central cross change to an open square:\n    <br>\n      <center><img src='./assets/sprites/cross/predictionSquare.svg'></center>\n    <br>\n    "}},lockedCross={title:{en:"New feature: Locked state"},content:{en:"You will have a certain amount of time to predict, like in previous state. But in this level after the prediction time is over, you will get into a short \"locked state\".\n  <br>During this state you will not be able to predict and you will have to wait for the next position of the agent.<br>\n    In locked mode the center cross will be a full square if you did not predict:\n    <br>\n      <center><img src='./assets/sprites/cross/fullSquare.svg'></center>\n    <br><br>\n    Or will be locked in the position you picked, here it is locked top-left:\n    <br>\n      <center><img src='./assets/sprites/cross/lockedTopLeft.svg'></center>\n    <br><br>"}},catchRabbit={title:{en:"New feature: Trials without prediction"},content:{en:"On some of the trials you will not be asked to answer. The central square will stay with continuous borders, and the wolf or the rabbit will just move without any prediction phase."}},askfMRIContinue={title:{en:"End tutorial ?"},content:{en:'Do you feel confident you understand this new part of the task ? <br>\n    If not you can restard the tutorial by clicking here: <button class="btn btn-secondary dragbox-button smartmodal-closebutton" onClick="window.taskObject.context.stateManager.newEvent(\'restartTutorial\')">Restart tutorial</button>\n    <br><br>\n      If you feel confident, close the window to start the task !'}},noResponse={title:{en:"Are you still here ??"},content:{en:"You did not answer for a while, the game was paused to make sure you were still paying attention.<br>\n    Too much missing values makes our data unusable, cheating risk altering our results and might make us draw wrong conclusions.<br>\n    For this reason at the end of the task an algorithm will check the validity of the data. If the data is not valid you will not receive the bonus payment for adequate completion and we will refrain from using your service in future studies.\n        "}},level2Start={title:{en:"Start level 2 !"},content:{en:"Congratulations on finishing level 1 ! <br>\n    You will now start level 2, it is a bit harder ! "}},level3Start={title:{en:"Start level 3 !"},content:{en:"Congratulations on finishing level 1 and level 2 ! <br>\n    You will now start level 3. This level is, again, a little harder.<br>\n    <br>\n    Good luck ! "}},tutorials={disclaimer:disclaimer,intro:intro,trialInstruction:trialInstruction,keyboardInstruction:keyboardInstruction,introToTryout:introToTryout,correctPrediction:correctPrediction,incorrectPrediction:incorrectPrediction,askContinue:askContinue,fmriIntro:fmriIntro,askfMRIContinue:askfMRIContinue,level2Start:level2Start,level3Start:level3Start,noResponse:noResponse,progressInstruction:progressInstruction,fourLevels:fourLevels,catchRabbit:catchRabbit,fmriDelay:fmriDelay,lockedCross:lockedCross},pageOrderTutorialOne=["intro","disclaimer","trialInstruction","fourLevels","progressInstruction","keyboardInstruction","introToTryout"],pageOrderTutorialFMRI=["fmriIntro","catchRabbit","lockedCross"],awakeTutorial=function(){var currentTutorial=this.stateManager.get("currentTutorial",1),pageOrder=1===currentTutorial?pageOrderTutorialOne:pageOrderTutorialFMRI;this.stateManager.set("currentPage",pageOrder[0]);var showIntro=new _experimentJs.EventData(this.R.get.events_showModal,this.stateManager.timeInMs+100,{page:pageOrder[0]});this.stateManager.addTimeTriggerEvent(showIntro),this.stateManager.set("levelObject",{level:"tutorial-"+currentTutorial}),this.state.shouldPause=!0},showModal=function(_ref){var _this=this,_ref$data$page=_ref.data.page,page=void 0===_ref$data$page?"intro":_ref$data$page;if(null!==this.taskObject.currentModal)try{this.taskObject.currentModal.modalBox.destroy()}catch(e){(0,_experimentJs.debugWarn)(e)}(0,_experimentJs.delay)(50).then(function(){if(tutorials.hasOwnProperty(page)){var tutorial=tutorials[page],event=new _experimentJs.EventData(_this.R.get.events_modalDismissed,{page:page});_this.taskObject.modal({type:"centralLarge",title:tutorial.title.en,content:tutorial.content.en,event:event})}})},tutorialUnfrozen=function(){(0,_experimentJs.hasConstructor)(Object,this.taskObject.currentModal)&&(0,_experimentJs.hasConstructor)(_experimentBoxes.SmartModal,this.taskObject.currentModal.modalBox)&&this.taskObject.currentModal.modalBox.show()},showNextPage=function(_ref2){var _ref2$data$page=_ref2.data.page,currentPage=void 0===_ref2$data$page?this.stateManager.get("currentPage","intro"):_ref2$data$page,currentTutorial=this.stateManager.get("currentTutorial",1),pageOrder=1===currentTutorial?pageOrderTutorialOne:pageOrderTutorialFMRI,R=this.R,currentIndex=pageOrder.indexOf(currentPage);if(-1===currentIndex)throw new Error("state.showNextPage: invalid currentPage.");if(currentIndex!==pageOrder.length-1){var showEvent=new _experimentJs.EventData(R.get.events_showModal,{page:pageOrder[currentIndex+1]});this.stateManager.addEvent(showEvent)}else(0,_experimentJs.debuglog)("state.showNextPage: end of tutorial."),this.stateManager.goToState(R.get.states_tryout,!0)};exports.showNextPage=showNextPage,exports.showModal=showModal,exports.awakeTutorial=awakeTutorial,exports.tutorials=tutorials,exports.tutorialUnfrozen=tutorialUnfrozen},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_jquery=__webpack_require__(16),_jquery2=_interopRequireDefault(_jquery),_lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentJs=__webpack_require__(0),_experimentBoxes=__webpack_require__(4),_MainScene=__webpack_require__(9),_MainScene2=_interopRequireDefault(_MainScene);window.taskObject=null,window.calibrator=null;var defferedDomLoaded=new _experimentJs.Deferred;if(document.addEventListener("DOMContentLoaded",function(){defferedDomLoaded.resolve()}),"undefined"!=typeof window){var scripts=document.getElementsByTagName("script");if(scripts.length){var assetsFolderFullpath=scripts[scripts.length-1].src,delimiterIndices=assetsFolderFullpath.indicesOf("/");window.assetsFolderFullpath=assetsFolderFullpath.substr(0,delimiterIndices[delimiterIndices.length-2])}else window.assetsFolderFullpath="./"}var R=new _experimentJs.RessourceManager;window.p1=defferedDomLoaded.promise,window.p2=R.addFiles(window.assetsFolderFullpath+"/assets/sequences/sequencesJune2017.json",window.assetsFolderFullpath+"/assets/json/ressources.json");var imageToPreload=[window.assetsFolderFullpath+"/assets/sprites/cross/predictionSquare.svg",window.assetsFolderFullpath+"/assets/sprites/keyboard/fullsize_color_legend.png",window.assetsFolderFullpath+"/assets/sprites/cross/fullSquare.svg",window.assetsFolderFullpath+"/assets/sprites/cross/predictionSquareWithLoader.gif"],_preloadImages=_experimentJs.preloadImages.apply(void 0,imageToPreload),_preloadImages2=_slicedToArray(_preloadImages,2),p3=_preloadImages2[0],preloadedImages=_preloadImages2[1];Object.assign(window,{p3:p3,preloadedImages:preloadedImages}),window.loadingPromise=Promise.all([window.p1,window.p2,window.p3]),window.loadingPromise.then(function(){function loginForm(){var fields={userId:{type:"input",constraints:"length:10,300",authorizedValues:null,parent:null,title:"Enter your MTurk WorkerID:"},password:{type:"password",constraints:"length:6,300; score: 30",authorizedValues:null,parent:null,title:"Enter your password, if you are new here you are free to pick one !"}},options={fields:fields,title:"Login Form",format:"topCentralSmall",callback:function(fields){(0,_experimentJs.debuglog)({endpoint:endpoint,credentials:{userId:fields.userId.value,password:fields.password.value}})}},form=new _experimentBoxes.SmartForm(options);form.buttonText="OK";var R=taskObject.context.R,stateManager=taskObject.context.stateManager;return stateManager&&stateManager.goToState(R.get.states_active),form}var taskObject=new _experimentJs.TaskObject((0,_jquery2.default)(".task-canvas"));taskObject.R.mergeWith(R);var fullSequenceObjectLevel1=R.get["fullSequenceObjectLevel1Classic0.90-1423-0.08errorTotal"],fullSequenceObjectLevel2=R.get["fullSequenceObjectLevel2Classic0.85-1243-0.25errorTotal"],fullSequenceObjectLevel3=R.get["fullSequenceObjectLevel3Classic0.75-1342-0.096errorTotal"],fullSequenceObjectLevel4=R.get["levelFourWithRandomAndNogoDependant-1324-0.75-0.32TotalError"],baseLevel={level:0,sequence:null,numberOfBlocks:0,sequenceObject:null,dominantProbability:.9,dominantStructure:"1423",observationDuration:500,interObservationDuration:50,probeObservationDuration:1e3,predictionDuration:2500,feedbackDuration:1500,minISIAfterLearning:2500,maxISIAfterLearning:3500,minISIAfterFeedback:2500,maxISIAfterFeedback:3500,observationSegmentSizes:[1],observationSegmentRepetitionPerBlock:75,feedbackType:"transition"},levelOne={level:1,dominantProbability:.9,dominantStructure:"1423",numberOfBlocks:1,sequenceObject:fullSequenceObjectLevel1};levelOne=_lodash2.default.extend(baseLevel,levelOne),taskObject.parameters.levelOne=levelOne;var levelTwo={level:2,dominantProbability:.85,dominantStructure:"1243",sequenceObject:fullSequenceObjectLevel2};taskObject.parameters.levelTwo=_lodash2.default.extend(_lodash2.default.clone(baseLevel),levelTwo);var levelThree={level:3,dominantProbability:.75,dominantStructure:"1342",sequenceObject:fullSequenceObjectLevel3};taskObject.parameters.levelThree=_lodash2.default.extend(_lodash2.default.clone(baseLevel),levelThree),taskObject.parameters.levelFour={level:4,dominantProbability:.75,observationDuration:500,dominantStructure:"1324",fixedISIAfterObservation:2500,sampleMeanISIAfterObservation:3e3,predictionDuration:2e3,fixedISIAfterPrediction:1e3,sampleMeanISIAfterPrediction:3e3,fixedBlackScreenDuration:1500,sampleMeanBlackScreen:500,maxSampleAfterPrediction:4e3,maxSampleAfterObservation:4e3,maxSampleBlackScreen:1e3,feedbackType:"transition",sound:!1,sequenceObject:fullSequenceObjectLevel4},taskObject.parameters.levels=[taskObject.parameters.levelOne,taskObject.parameters.levelTwo,taskObject.parameters.levelThree,taskObject.parameters.levelFour],taskObject.variables.shouldSeeInformation=!0,taskObject.assetsToLoad={rabbitFace:{path:"/assets/sprites/rabbit/rabbitFace.png",type:"texture"},wolfFace:"/assets/sprites/wolf/wolfFace.png",crossSheet:{path:"/assets/sprites/cross/squareSheetMargin.svg",type:"texture"},observation:{path:"/assets/sounds/observation.mp3",type:"sound"},predict:{path:"/assets/sounds/predict.mp3",type:"sound"}};var options={level:null};taskObject.registerSceneGenerator(_MainScene2.default,options);var sceneNames=["loading","main"];taskObject.R.add({agent:{scale:.15,predictionOpacity:0,animate:!1},tile:{scale:2,offset:40,fullOpacity:.2,lowOpacity:.2},cross:{opacity:1}});var parametersNames=["parameters.levelFour.observationDuration","parameters.levelFour.fixedISIAfterObservation","parameters.levelFour.sampleMeanISIAfterObservation","parameters.levelFour.predictionDuration","parameters.levelFour.fixedISIAfterPrediction","parameters.levelFour.sampleMeanISIAfterPrediction","parameters.levelFour.fixedBlackScreenDuration","parameters.levelFour.sampleMeanBlackScreen","parameters.levelFour.maxSampleAfterPrediction","parameters.levelFour.maxSampleAfterObservation","parameters.levelFour.maxSampleBlackScreen"],parametersConstraints={feedbackType:["transition","sound"],currentScene:sceneNames},rParams=["agent.scale","agent.predictionOpacity","tile.scale","tile.offset","cross.opacity"];taskObject.paramBox.bind(taskObject,parametersNames,parametersConstraints),taskObject.paramBox.bind(taskObject.R.data,rParams),window.taskObject=taskObject;var tempMaxNumberOfRetry=taskObject.dataManager.MAX_NUMBER_OF_RETRY,endpoint=window.assetsFolderFullpath+"/api/php/mysql/index.php";taskObject.setConnection({endpoint:endpoint,signInForm:loginForm}).then(function(connection){return!!connection.loggedIn||taskObject.dataManager.login(connection)}).then(function(){return taskObject.dataManager.MAX_NUMBER_OF_RETRY=tempMaxNumberOfRetry,taskObject.startTask()}).then(function(message){(0,_experimentJs.debuglog)(message),taskObject.paramBox.bind(taskObject,"currentScene",parametersConstraints),void 0!==taskObject.paramBox.queryString.generateSequence?taskObject.currentScene="sequenceGeneratorScene":1!==sceneNames.length&&void 0!==taskObject.paramBox.queryString.currentScene||(taskObject.currentScene="main")})})},function(module,exports,__webpack_require__){"use strict";"undefined"!=typeof window&&__webpack_require__(7)},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function MainScene(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},optionsBase={sceneKey:"main",canvasBackground:new _experimentBabylonJs2.default.Color4(0,0,0,1),backgroundRoundRadius:0,clearColor:new _experimentBabylonJs2.default.Color4(0,0,0,1),canvasPercentWidth:1,canvasPercentHeight:1,mode:"central",level:null};options=_lodash2.default.extend(optionsBase,options);var taskObject=this.taskObject,scene=taskObject.create2DScene(options),stateManager=scene.stateManager,R=taskObject.R;scene.onResize=[_globalFunctions.redrawAssets];var sounds={observation:taskObject.cloneAssetIntoScene(R.get.sounds_observation,scene),prediction:taskObject.cloneAssetIntoScene(R.get.sounds_predict,scene)};stateManager.setGlobal("sounds",sounds),stateManager.register(_globalFunctions.drawTiles,_globalFunctions.addButton,_globalFunctions.disposeOfButtons,_globalFunctions.clearTiles,_globalFunctions.getTilePositions,_globalFunctions.getTileSize,_globalFunctions.getTileMargins,_globalFunctions.highlightPosition,_globalFunctions.drawPredictionTiles,_globalFunctions.setAgent,_globalFunctions.moveAgentToTile,_globalFunctions.animateAgentToTile,_globalFunctions.getAgentPositionOnTile,_globalFunctions.getAgentMarginsOnTile,_globalFunctions.setAgentOpacity,_globalFunctions.setBlackScreen,_globalFunctions.hideAll,_globalFunctions.showAll,_globalFunctions.redrawAssets,_globalFunctions.checkIdleAndConnection),stateManager.call("redrawAssets");var dataManager=this.dataManager,cwDataFields=["subject_id","level","block","block_type","dominant_structure","dominant_transition_probability","trial","trial_type","position","observation_duration","observed_transition_was_dominant","transition_to","subject_choice","correct","response_time","key_hits","clicks","has_paused","start_observation","responded_at","start_prediction","end_prediction"];dataManager.addTable("cwData",cwDataFields),dataManager.addTable("tryoutData",cwDataFields);var userId="unknown"+this.timeInMs;try{userId=dataManager.connections[0].credentials.userId}catch(e){(0,_experimentJs.debugError)(e)}stateManager.set("subject_id",userId);var eventFields=["id","flag","happenedAt","handledAt","data"];dataManager.addTable("stateRunningEventsLvl1",eventFields),dataManager.addTable("stateRunningEventsLvl2",eventFields),dataManager.addTable("stateRunningEventsLvl3",eventFields),dataManager.addTable("stateRunningEventsLvl4",eventFields),dataManager.addTable("stateActiveEvents",eventFields),stateManager.setGlobal("positionData",{indexOnTransitionSequence:-1,indexOnPredictionSequence:-1,fullSequenceIndex:-1}),stateManager.setGlobal("hasSeenLearningInfo",!1),stateManager.setGlobal("hasSeenPredictionInfo",!1),R.add({states:{running:"running",tutorial:"tutorial",tryout:"tryout",tryoutFMRI:"tryoutFMRI",end:"end"},checkpoint:{tutorialDone:["tutorialOneDone","tutorialTwoDone"],levelDone:["levelOneDone","levelTwoDone","levelThreeDone","levelFourDone"],taskDone:"taskDone",taskEndNoComeback:"taskEndNoComeback"},flags:{levelDefined:"levelDefined"},events:{sequenceGenerated:"sequenceGenerated",goNextPosition:"goNextPosition",endObservation:"endObservation",startPrediction:"startPrediction",responseTimeEnded:"responseTimeEnded",isiAfterLearningEnded:"isiAfterLearningEnded",feedbackEnded:"feedbackEnded",isiAfterFeedbackEnded:"isiAfterFeedbackEnded",pauseTransition:"pauseTransition",forcePause:"forcePause",predictionStartBlackout:"predictionStartBlackout",blackoutEnds:"blackoutEnds",predictionEndsBlackout:"predictionEndsBlackout",isiAfterPredictionEndsBlackout:"isiAfterPredictionEndsBlackout",screenWentBlack:"screenWentBlack",playPredictionSound:"playPredictionSound",playObservationSound:"playObservationSound",showModal:"showModal",goToTutorial:"goToTutorial",hasResponded:"hasResponded",restartTutorial:"restartTutorial",goToLevel1:"goToLevel1",goToLevel2:"goToLevel2",goToLevel3:"goToLevel3",goToLevel4:"goToLevel4",tic:"tic",moreThanFiveNA:"moreThanFiveNA",aknowledgedEnding:"aknowledgedEnding"}});var _stateManager$addStat=stateManager.addState(R.get.states_tutorial,R.get.states_running,R.get.states_tryout,R.get.states_end),_stateManager$addStat2=_slicedToArray(_stateManager$addStat,4),tutorialState=_stateManager$addStat2[0],runningState=_stateManager$addStat2[1],tryoutState=_stateManager$addStat2[2],endState=_stateManager$addStat2[3],pauseState=stateManager.states.pause;if(null!==options.level){var eventData=new _experimentJs.EventData(R.get.flags_levelDefined,scene.stateManager.timeInMs,{belongsTo:["globalLog","stateActiveEvents"],handledAt:null,storedAt:null,level:options.level});stateManager.addEvent(eventData)}else stateManager.states.active.addAwakeningFunctions(_active.selectLevel);stateManager.states.active.addEndingFunctions(_active.endActive),stateManager.states.active.addEventFunctions(R.get.flags_levelDefined,_active.startLevel),stateManager.states.active.addEventFunctions(R.get.events_goToTutorial,function(_ref){var tutorial=_ref.data.tutorial;stateManager.setGlobal("currentTutorial",tutorial),stateManager.goToState(R.get.states_tutorial)});var goToPause=function(){this.state.shouldPause&&(this.state.freeze(),(0,_experimentJs.hasConstructor)(Object,this.taskObject.currentModal)&&(0,_experimentJs.hasConstructor)(_experimentBoxes.SmartModal,this.taskObject.currentModal.modalBox)&&this.taskObject.currentModal.modalBox.hide(),this.stateManager.goToState(this.R.get.states_pause))};return runningState.addAwakeningFunctions(_running.startRunning),runningState.addEventFunctions(R.get.events_goNextPosition,_running.goToNextPosition),runningState.addEventFunctions(R.get.events_endObservation,_running.endObservation),runningState.addEventFunctions(R.get.events_startPrediction,_running.startPrediction),runningState.addEventFunctions(R.get.events_responseTimeEnded,_running.endPrediction),runningState.addEventFunctions(R.get.events_pauseTransition,_running.pauseTransition),runningState.addEventFunctions(R.get.events_unfrozen,_running.stateUnfrozen),runningState.addEventFunctions(R.get.events_forcePause,goToPause),runningState.addEventFunctions(R.get.events_windowBlur,goToPause),runningState.addEventFunctions(R.get.events_moreThanFiveNA,goToPause),runningState.addEventFunctions(R.get.events_click,_running.checkForClickPrediction),runningState.addEventFunctions(R.get.events_keydown,_running.checkKeyStrokeForPrediction),runningState.addEventFunctions(R.get.events_playPredictionSound,_running.playSound),runningState.addEventFunctions(R.get.events_playObservationSound,_running.playSound),tutorialState.addAwakeningFunctions(_tutorial.awakeTutorial),tutorialState.addEventFunctions(R.get.events_modalDismissed,_tutorial.showNextPage),tutorialState.addEventFunctions(R.get.events_showModal,_tutorial.showModal),tutorialState.addEventFunctions(R.get.events_windowBlur,goToPause),tutorialState.addEventFunctions(R.get.events_unfrozen,_tutorial.tutorialUnfrozen),tutorialState.addEventFunctions(R.get.events_playPredictionSound,_running.playSound),tutorialState.addEventFunctions(R.get.events_playObservationSound,_running.playSound),dataManager.addTable("stateTryout1",eventFields),dataManager.addTable("stateTryout2",eventFields),tryoutState.addAwakeningFunctions(_tryout.awakeTryout),tryoutState.addEndingFunctions(_tryout.tryoutEnd),tryoutState.addEventFunctions(R.get.events_goNextPosition,_tryout.tryoutGoToNextPosition),tryoutState.addEventFunctions(R.get.events_endObservation,_running.endObservation),tryoutState.addEventFunctions(R.get.events_windowBlur,goToPause),tryoutState.addEventFunctions(R.get.events_unfrozen,_tutorial.tutorialUnfrozen),tryoutState.addEventFunctions(R.get.events_startPrediction,_tryout.tryoutStartPrediction),tryoutState.addEventFunctions(R.get.events_responseTimeEnded,_tryout.tryoutEndPrediction),tryoutState.addEventFunctions(R.get.flags_levelDefined,_active.startLevel),tryoutState.addEventFunctions(R.get.events_restartTutorial,function(){stateManager.goToState(R.get.states_tutorial)}),tryoutState.addEventFunctions(R.get.events_keydown,_tryout.tryoutCheckKeyStrokeForPrediction),tryoutState.addEventFunctions(R.get.events_click,_running.checkForClickPrediction),pauseState.addAwakeningFunctions(_pause.awakenPause),pauseState.addEndingFunctions(_pause.endPause),pauseState.addEventFunctions(R.get.events_keydown,_pause.pauseKeyDown),pauseState.addEventFunctions(R.get.events_windowFocus,_pause.pauseKeyDown),endState.addAwakeningFunctions(_end.awakenEnd),scene}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(_experimentJs.Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();exports.default=MainScene;var _lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_experimentBoxes=__webpack_require__(4),_globalFunctions=__webpack_require__(5),_active=__webpack_require__(10),_tutorial=__webpack_require__(6),_tryout=__webpack_require__(14),_running=__webpack_require__(13),_pause=__webpack_require__(12),_end=__webpack_require__(11)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.endActive=exports.selectLevel=exports.startLevel=void 0;var _experimentJs=__webpack_require__(0),selectLevel=function(){var _this=this;if(void 0===this.state)throw new Error("state.selectLevel: state is undefined");var stateManager=this.stateManager,dataManager=this.dataManager,R=this.R,checkTaskDone=dataManager.query("hasCheckpoint",{checkpoint:R.get.checkpoint_taskDone},this.connection),checkTaskEndNoComeback=dataManager.query("hasCheckpoint",{checkpoint:R.get.checkpoint_taskEndNoComeback},this.connection);stateManager.call("hideAll");var deferred=new _experimentJs.Deferred;return Promise.all([checkTaskDone,checkTaskEndNoComeback]).then(function(results){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=results[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var result=_step.value;if(void 0===result.code)stateManager.currentStateKey!==R.get.states_idle&&stateManager.goToState(R.get.states_idle),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:"active"})});else if(result.code===R.get.checkpoint_taskDone||result.code===R.get.checkpoint_taskEndNoComeback)return stateManager.set("endReason",result.message),stateManager.goToState(R.get.states_end),deferred.resolve("active.selectLevel: end of task"),!1}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return _this.dataManager.query("getCheckpoint",null,_this.connection)}).then(function(result){if(!1!==result){void 0===result.code&&(stateManager.currentStateKey!==R.get.states_active&&stateManager.goToState(R.get.states_idle),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:"active"})}));var eventLevel=void 0;switch(result.code){case R.get.checkpoint_tutorialDone[0]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:1});break;case R.get.checkpoint_tutorialDone[1]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:4});break;case R.get.checkpoint_levelDone[0]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:2});break;case R.get.checkpoint_levelDone[1]:eventLevel=new _experimentJs.EventData(R.get.flags_levelDefined,stateManager.timeInMs,{level:3});break;case R.get.checkpoint_levelDone[2]:eventLevel=new _experimentJs.EventData(R.get.events_goToTutorial,stateManager.timeInMs,{tutorial:2});break;case R.get.checkpoint_levelDone[3]:stateManager.set("endReason","You finished the task finished"),stateManager.goToState(R.get.states_end);break;case R.get.checkpoint_taskDone:case R.get.checkpoint_taskEndNoComeback:stateManager.set("endReason",result.message),stateManager.goToState(R.get.states_end);break;default:eventLevel=new _experimentJs.EventData(R.get.events_goToTutorial,stateManager.timeInMs,{tutorial:1})}(0,_experimentJs.delay)(150).then(function(){stateManager.addEvent(eventLevel)}),deferred.resolve("active.selectLevel: level selected - resolved")}}).catch(function(){stateManager.currentStateKey!==R.get.states_active&&stateManager.goToState(R.get.states_idle),_this.taskObject.modal({type:"centralLarge",title:R.get.lostConnectionTitle,content:R.get.lostConnectionContent}).then(function(){return(0,_experimentJs.delay)(50)}).then(function(){stateManager.call("checkIdleAndConnection",{returnToState:"active"})})}),deferred.promise},startLevel=function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(void 0===this.taskObject)throw new Error("state.startLevel: this.taskObject is undefined");if(void 0===options.data.level)throw new Error("state.startLevel: options.level is undefined");var taskObject=this.taskObject,stateManager=this.stateManager,R=this.R,elements2D=stateManager.get("elements2D");return stateManager.emptyTimeTriggerEvents(),elements2D.agent.opacity=0,stateManager.promise("disposeOfButtons"),stateManager.setGlobal("level",options.data.level),stateManager.setGlobal("levelObject",taskObject.parameters.levels[options.data.level-1]),stateManager.set("positionData",{indexOnTransitionSequence:-1,indexOnPredictionSequence:-1,fullSequenceIndex:taskObject.parameters.levels[options.data.level-1].sequenceObject.fullSequence.length-3}),stateManager.currentStateKey!==R.get.states_running&&stateManager.goToState(R.get.states_running),"state.startLevel: resolved"},endActive=function(){this.stateManager.promise("disposeOfButtons")};exports.startLevel=startLevel,exports.selectLevel=selectLevel,exports.endActive=endActive},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.awakenEnd=void 0;var _experimentJs=__webpack_require__(0),awakenEnd=function(){var _this=this,R=this.R,scene=this.scene;this.stateManager.call("hideAll"),scene.initialGui.levelVisible=!1,this.dataManager.query("hasCheckpoint",{checkpoint:R.get.checkpoint_taskDone},this.connection).then(function(r){var event=new _experimentJs.EventData(_this.R.get.events_aknowledgedEnding);_this.stateManager.onNext(_this.R.get.events_aknowledgedEnding,function(){window.open("","_self").close()});var reason="You completed the task !",title=R.get.taskFinishedTitle,content=R.get.taskFinishedContent;r.code!==R.get.checkpoint_taskDone?(reason=_this.stateManager.get("endReason",""),title=R.get.taskStoppedTitle,content=R.get.taskStoppedMessage,""!==reason&&(content+=R.get.taskStoppedReason.replace("{t}",reason)),_this.taskObject.setCheckpoint(R.get.checkpoint_taskEndNoComeback,reason),_this.taskObject.modal({type:"centralLarge",title:title,content:content,event:event})):_this.taskObject.modal({type:"centralLarge",title:title,content:content,event:event})})};exports.awakenEnd=awakenEnd},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.pauseKeyDown=exports.endPause=exports.awakenPause=void 0;var _experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_globalFunctions=__webpack_require__(5),awakenPause=function(){var stateManager=this.stateManager,levelObject=stateManager.get("levelObject"),GUI=stateManager.get("GUI"),R=this.R,state=this.state,pauseTime=stateManager.timeInMs;stateManager.get("sounds").prediction.play(),state.hitKeyTime=null,state.initialGuiVisible=GUI.levelVisible,GUI.backgroundFill=_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(0,0,0,1)),GUI.levelVisible=!0,stateManager.get("lastPauseInfo",{level:levelObject.level,time:pauseTime}).level!==levelObject.level&&stateManager.set("pauseTimeLeft",3e4);var currentTimeLeft=stateManager.get("pauseTimeLeft",3e4);stateManager.set("lastPauseInfo",{level:levelObject.level,time:pauseTime});var options={id:"pauseText",parent:GUI,marginAlignment:"h: center, v: center",fontName:"30pt Arial",fontSignedDistanceField:!0};state.timerText=function(){var timeLeft=parseInt((currentTimeLeft-stateManager.timeInMs+pauseTime)/1e3,10);return!(timeLeft<0)&&R.get.timeLimitText.replace("{n}",(0,_experimentJs.String)(timeLeft))};var t=0;state.tic=function(){state.centerText.levelVisible=!0;var text=state.timerText();!1===text?(stateManager.set("endReason","You were idle for more than 30 min during level "+levelObject.level),stateManager.goToState(R.get.states_end)):(state.centerText.text=text,(0,_experimentJs.delay)(200).then(function(){stateManager.currentStateKey===R.get.states_pause&&state.tic()}),(t+=200)>=2e3&&(stateManager.get("sounds").prediction.play(),t=0))},(0,_experimentJs.hasConstructor)(_experimentBabylonJs2.default.Text2D,state.centerText)?(state.topText.levelVisible=!0,state.centerText.levelVisible=!0,state.centerText.text=state.timerText):(state.topText=new _experimentBabylonJs2.default.Text2D(R.get.pauseText,options),(0,_globalFunctions.setMargins)(state.topText,{topPixels:0,bottomPixels:40,leftPixels:0,rightPixels:0}),state.centerText=new _experimentBabylonJs2.default.Text2D(state.timerText(),options)),(0,_experimentJs.delay)(200).then(function(){stateManager.currentStateKey===R.get.states_pause&&state.tic()})},pauseKeyDown=function(){var state=this.state,stateManager=this.stateManager,levelObject=stateManager.get("levelObject"),R=this.R,context=this;null===state.hitKeyTime&&(state.hitKeyTime=stateManager.timeInMs),state.timerText=function(){var timeLeft=Math.ceil((3e3-stateManager.timeInMs+state.hitKeyTime)/1e3,10);return!(timeLeft<0)&&R.get.pauseRestart.replace("{n}",(0,_experimentJs.String)(timeLeft))},state.tic=function(){var text=state.timerText();!1!==text?(state.centerText.text=text,(0,_experimentJs.delay)(200).then(function(){if(document.hasFocus())stateManager.currentStateKey===R.get.states_pause&&state.tic();else{var lastPauseInfo=stateManager.get("lastPauseInfo",{level:levelObject.level,time:stateManager.timeInMs}),previousTimeLeft=stateManager.get("pauseTimeLeft",3e5),currentTimeLeft=previousTimeLeft-stateManager.timeInMs+lastPauseInfo.time;stateManager.set("pauseTimeLeft",currentTimeLeft),awakenPause.bind(context)()}})):stateManager.frozenState&&stateManager.goToState(stateManager.frozenState)},(0,_experimentJs.delay)(200).then(function(){document.hasFocus()?stateManager.currentStateKey===R.get.states_pause&&state.tic():awakenPause.bind(context)()})},endPause=function(){var stateManager=this.stateManager,state=this.state,levelObject=stateManager.get("levelObject"),GUI=stateManager.get("GUI"),R=this.R;GUI.backgroundFill=_experimentBabylonJs2.default.Canvas2D.GetSolidColorBrush(new _experimentBabylonJs2.default.Color4(1,1,1,0)),GUI.levelVisible=state.initialGuiVisible,state.hitKeyTime=null,state.topText.levelVisible=!1,state.centerText.levelVisible=!1;var lastPauseInfo=stateManager.get("lastPauseInfo",{level:levelObject.level,time:stateManager.timeInMs}),previousTimeLeft=stateManager.get("pauseTimeLeft",3e5),currentTimeLeft=previousTimeLeft-stateManager.timeInMs+lastPauseInfo.time;currentTimeLeft<0?stateManager.call("prematureEnd",{reason:R.get.prematureEndPauseAboveThreshold}):stateManager.set("pauseTimeLeft",currentTimeLeft)};exports.awakenPause=awakenPause,exports.endPause=endPause,exports.pauseKeyDown=pauseKeyDown},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.pauseTransition=exports.endObservation=exports.playSound=exports.endPrediction=exports.checkKeyStrokeForPrediction=exports.checkForClickPrediction=exports.startPrediction=exports.goToNextPosition=exports.startRunning=exports.stateUnfrozen=void 0;var _lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_taskUtilities=__webpack_require__(3),stateUnfrozen=function(){_lodash2.default.has(this.state,"currentTrialData.hasPaused")&&(this.state.currentTrialData.hasPaused=!0)},pauseTransition=function(){var _this=this,stateManager=this.stateManager,state=this.state,R=this.R,level=stateManager.get("levelObject")?stateManager.get("levelObject").level:"";try{var levelObject=stateManager.get("levelObject"),sequenceObject=levelObject.sequenceObject,positionData=stateManager.get("positionData"),startTransitionTime=stateManager.timeInMs;state.currentTrialData=null,stateManager.call("hideAll");var text2d=void 0;if(level<=3){this.taskObject.setCheckpoint(R.get.checkpoint_levelDone[level-1]);var promise=stateManager.resolveOnKey(),shouldtic=!0,transitionText=function(){var timeLeft=Math.ceil((9e5-stateManager.timeInMs+startTransitionTime)/1e3,10);return!(timeLeft<0)&&R.get.finishedLevelTransition.replace("{n}",(0,_experimentJs.String)(timeLeft)).replace("{l}",level)};state.tic=function(){if(shouldtic){var text=transitionText();!1!==text?(text2d.text=text,state.tooltipPause.box.levelVisible=!0,(0,_experimentJs.delay)(200).then(function(){state.tooltipPause.box.levelVisible=!1,state.tic()})):(stateManager.set("endReason","You were idle for more than 15 min"),stateManager.goToState(R.get.states_end))}};var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5);state.tooltipPause=stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,this.taskObject.renderSize.height/2-100)),text:transitionText(),duration:promise}),text2d=state.tooltipPause.text,this.state.shouldPause=!1,state.tic(),promise.then(function(){shouldtic=!1,stateManager.goToState(R.get.states_active)})}else if(4===level&&positionData.fullSequenceIndex>=sequenceObject.block.length-1)this.taskObject.setCheckpoint(R.get.checkpoint_levelDone[level-1]),this.taskObject.setCheckpoint(R.get.checkpoint_taskDone).promise.then(function(){stateManager.goToState(R.get.states_end)});else if(4===level){positionData.fullSequenceIndex-=1;var blockDone=sequenceObject.block[positionData.fullSequenceIndex],_startTransitionTime=stateManager.timeInMs,_promise=stateManager.resolveOnKey(),_shouldtic=!0,_transitionText=function(){var timeLeft=Math.ceil((3e5-stateManager.timeInMs+_startTransitionTime)/1e3,10);return!(timeLeft<0)&&R.get.finishedBlockTransition.replace("{n}",(0,_experimentJs.String)(timeLeft)).replace("{b}",blockDone+1)};state.tic=function(){if(_shouldtic){var text=_transitionText();!1!==text?(text2d.text=text,state.tooltipPause.box.levelVisible=!0,(0,_experimentJs.delay)(200).then(function(){state.tooltipPause.box.levelVisible=!1,state.tic()})):(stateManager.set("endReason","You were idle for more than 5 min"),stateManager.goToState(R.get.states_end))}};var _centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5);state.tooltipPause=stateManager.tooltip({position:_centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,this.taskObject.renderSize.height/2-100)),text:_transitionText(),duration:_promise}),text2d=state.tooltipPause.text,this.state.shouldPause=!1,state.tic(),_promise.then(function(){_shouldtic=!1,_this.state.shouldPause=!0,stateManager.call("showAll");var nextTransitionTime=_this.stateManager.timeInMs+100;stateManager.newEvent(R.get.events_goNextPosition,nextTransitionTime,null,["globalLog","stateRunningEventsLvl"+levelObject.level])})}}catch(e){(0,_experimentJs.debugError)("running.pauseTransition: error with the level data."),stateManager.set("endReason","There was an error with the task. We are sorry."),stateManager.goToState(R.get.states_end)}},startRunning=function(){var _this2=this;if(void 0===this.taskObject)throw new Error("state.startRunning: this.taskObject is undefined");var stateManager=this.stateManager,state=this.state,R=stateManager.R;document.hasFocus()||stateManager.newEvent(R.get.forcePause),state.shouldPause=!0,state.pausedBetween=[];var levelObject=stateManager.get("levelObject"),elements2D=stateManager.get("elements2D");stateManager.call("showAll"),elements2D.loader.value=0,void 0===state.data&&(state.data=[]),state.numberOfMissed=0,state.isPredicting=!1;var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5),promise=stateManager.resolveOnKey();return stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,this.taskObject.renderSize.height/2-100)),text:"You are about to start level "+levelObject.level+"\nHit a key to start",duration:promise}),promise.then(function(){var nextTransitionTime=_this2.stateManager.timeInMs+100,nextTransitionEvent=new _experimentJs.EventData(R.get.events_goNextPosition,nextTransitionTime,{belongsTo:["globalLog","stateRunningEventsLvl"+levelObject.level],handledAt:null,storedAt:null});stateManager.addTimeTriggerEvent(nextTransitionEvent)}),"state.startRunning: resolved"},storeData=function(){var state=this.state,stateManager=this.stateManager,levelObject=stateManager.get("levelObject"),sequenceObject=levelObject.sequenceObject,positionData=stateManager.get("positionData"),index=positionData.fullSequenceIndex,dataToStore=state.currentTrialData;try{if((0,_experimentJs.hasConstructor)(Object,state.currentTrialData)&&stateManager.get("subject_id")){var _state$currentTrialDa=state.currentTrialData,level=_state$currentTrialDa.level,block=_state$currentTrialDa.block,blockType=_state$currentTrialDa.blockType,trial=_state$currentTrialDa.trial,trialType=_state$currentTrialDa.trialType,position=_state$currentTrialDa.position,choice=_state$currentTrialDa.choice,responseTime=_state$currentTrialDa.responseTime,startObservation=_state$currentTrialDa.startObservation,_startPrediction=_state$currentTrialDa.startPrediction,respondedAt=_state$currentTrialDa.respondedAt,_endPrediction=_state$currentTrialDa.endPrediction,keysHits=_state$currentTrialDa.keysHits,hasPaused=_state$currentTrialDa.hasPaused,clicks=_state$currentTrialDa.clicks,_endObservation=_state$currentTrialDa.endObservation,dominant=null;if(levelObject.dominantStructure&&((0,_experimentJs.hasConstructor)(_experimentJs.String,levelObject.dominantStructure)||(levelObject.dominantStructure=(0,_experimentJs.String)(levelObject.dominantStructure)),dominant=0,index-1>=0&&sequenceObject.fullSequence[index-1]&&sequenceObject.fullSequence[index])){var positionIndexInStructure=levelObject.dominantStructure.indexOf(sequenceObject.fullSequence[index-1]);if(-1!==positionIndexInStructure){var nextIndex=3===positionIndexInStructure?0:positionIndexInStructure+1;parseInt(levelObject.dominantStructure[nextIndex],10)===sequenceObject.fullSequence[index]&&(dominant=1)}}var correct=null,transitionTo=null;index+1<sequenceObject.fullSequence.length&&(correct=parseInt(sequenceObject.fullSequence[index+1],10)===parseInt(choice,10),transitionTo=sequenceObject.fullSequence[index+1]),dataToStore={subject_id:stateManager.get("subject_id"),level:level,block:block,block_type:blockType,dominant_structure:levelObject.dominantStructure,dominant_transition_probability:levelObject.dominantProbability,trial:trial,trial_type:trialType,position:position,observation_duration:_startPrediction?_startPrediction-startObservation:this.timeInMs-startObservation,observed_transition_was_dominant:dominant,transition_to:transitionTo,subject_choice:choice,response_time:responseTime,correct:correct,key_hits:JSON.stringify(keysHits),clicks:JSON.stringify(clicks),has_paused:hasPaused,start_observation:startObservation,end_observation:_endObservation,start_prediction:_startPrediction,responded_at:respondedAt,end_prediction:_endPrediction,belongsTo:["cwData"]},stateManager.storeData(dataToStore),state.currentTrialData=null}}catch(e){var message="runningState.goToNextPosition: could not store cwData.";(0,_experimentJs.debugError)(message),stateManager.storeInErrorLog({message:message,timestamp:stateManager.timeInMs,data:dataToStore})}},goToNextPosition=function(){var event=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(void 0===this.state)throw new Error("state.goToNextPosition: state is undefined");var stateManager=this.stateManager,state=this.state,R=stateManager.R,levelObject=stateManager.get("levelObject");document.hasFocus()||stateManager.newEvent(R.get.events_windowBlur,null,null,["stateRunningEventsLvl"+levelObject.level]);var checkConnection=!1;(0,_experimentJs.hasConstructor)(_experimentJs.Deferred,this.state.checkLastInteraction)?this.state.checkLastInteraction.pending||(this.state.checkLastInteraction=new _experimentJs.Deferred,checkConnection=!0):(this.state.checkLastInteraction=new _experimentJs.Deferred,checkConnection=!0),checkConnection&&stateManager.call("checkIdleAndConnection",{deferred:this.state.checkLastInteraction});var elements2D=stateManager.get("elements2D"),sounds=stateManager.get("sounds"),cross=elements2D.cross,sequenceObject=levelObject.sequenceObject,positionData=stateManager.get("positionData"),souldPlaySound=!0===levelObject.sound,moveFunction="moveAgentToTile";void 0!==event.data&&void 0!==event.data.data&&void 0!==event.data.data.animate&&(moveFunction=event.data.data.animate?"animateAgentToTile":"moveAgentToTile"),storeData.bind(this)(),positionData.fullSequenceIndex+=1;var index=positionData.fullSequenceIndex;if(elements2D.loader.value=100*positionData.fullSequenceIndex/sequenceObject.fullSequence.length,index>=sequenceObject.fullSequence.length){positionData.fullSequenceIndex-=1;var nextTransitionEvent=new _experimentJs.EventData(R.get.events_pauseTransition,stateManager.timeInMs,{belongsTo:["globalLog","stateRunningEventsLvl"+levelObject.level],handledAt:null,storedAt:null});return stateManager.addTimeTriggerEvent(nextTransitionEvent),"goToNextPosition: resolved. End of sequence."}if(index>0&&sequenceObject.block[index-1]!==sequenceObject.block[index]&&-1===state.pausedBetween.indexOf(sequenceObject.block[index-1]))return state.pausedBetween.push(sequenceObject.block[index-1]),stateManager.newEvent(R.get.events_pauseTransition,null,null,["globalLog","stateRunningEventsLvl"+levelObject.level]),"goToNextPosition: resolved. Changing block.";var agentType="rabbit";4===levelObject.level&&"normal"!==sequenceObject.blockType[index]||(agentType="wolf"),elements2D.agentType!==agentType&&stateManager.promise("setAgent",{agent:agentType});var trialData={level:levelObject.level,fullSequenceIndex:index,block:sequenceObject.block[index],blockType:sequenceObject.blockType[index],trial:sequenceObject.trial[index],trialType:sequenceObject.trialType[index],state:state.stateKey,position:sequenceObject.fullSequence[index],choice:null,responseTime:null,startObservation:null,endObservation:null,respondedAt:null,startPrediction:null,endPrediction:null,nextPosition:null,observedTransitionWasDominant:null,keysHits:[],clicks:[],hasPaused:!1};state.data.push(trialData),state.currentTrialData=trialData,state.isPredicting=!1;var deferred=new _experimentJs.Deferred;return stateManager.call("drawTiles"),stateManager.call("setBlackScreen",{on:!1}),cross.spriteFrame=R.get.cross_base,stateManager.call("drawTiles"),stateManager.promise(moveFunction,{tile:trialData.position-1,opacity:1}).then(function(){if(souldPlaySound&&sounds.observation.play(),trialData.startObservation=stateManager.timeInMs,stateManager.newEvent(R.get.events_endObservation,levelObject.observationDuration,null,["stateRunningEventsLvl"+levelObject.level]),"classic"===trialData.trialType){(0,_experimentJs.debugWarn)("classic trial: moved to "+trialData.position);var startPredictionTime=levelObject.observationDuration+_lodash2.default.random(levelObject.minISIAfterLearning,levelObject.maxISIAfterLearning);stateManager.newEvent(R.get.events_startPrediction,startPredictionTime,null,["globalLog","stateRunningEventsLvl"+levelObject.level])}else if("observation_prediction"===trialData.trialType){(0,_experimentJs.debugWarn)("observation_prediction trial: moved to "+trialData.position);var observationTime=levelObject.observationDuration+levelObject.fixedISIAfterObservation+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterObservation,0,levelObject.maxSampleAfterObservation,levelObject.maxSampleAfterObservation);(0,_experimentJs.debugWarn)("Observation Time",(observationTime-stateManager.timeInMs)/1e3),stateManager.newEvent(R.get.events_startPrediction,parseInt(observationTime,10),null,["stateRunningEventsLvl"+levelObject.level])}else if("blackout"===trialData.trialType){(0,_experimentJs.debugWarn)("Blackout trial: moved to "+trialData.position);var _observationTime=levelObject.observationDuration+levelObject.fixedISIAfterObservation+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterObservation,0,levelObject.maxSampleAfterObservation,levelObject.maxSampleAfterObservation);(0,_experimentJs.debugWarn)("Observation Time",_observationTime/1e3);var blackoutTime=_observationTime+levelObject.fixedBlackScreenDuration+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanBlackScreen,0,levelObject.maxSampleBlackScreen,levelObject.maxSampleBlackScreen);stateManager.newEvent(R.get.events_goNextPosition,blackoutTime,null,["stateRunningEventsLvl"+levelObject.level]),(0,_experimentJs.debugWarn)("blackout Time",blackoutTime/1e3)}state.numberOfMissed>=5&&(stateManager.newEvent(R.get.events_moreThanFiveNA,null,null,["stateRunningEventsLvl"+levelObject.level]),deferred.resolve("goToNextPosition: resolved. Too many NA.")),deferred.resolve("stateManager.goToNextPosition: resolved")}),deferred.promise},endObservation=function(){return this.state.currentTrialData.endObservation=this.stateManager.timeInMs,this.stateManager.call("setAgentOpacity",{opacity:0}),"endObservation resolved"},startPrediction=function(){if(void 0===this.state.currentTrialData)throw new Error("state.startPrediction: state.currentTrialData is undefined");var state=this.state,stateManager=this.stateManager,R=stateManager.R;state.numberOfMissed+=1;var levelObject=stateManager.get("levelObject");stateManager.promise("setAgentOpacity",{opacity:R.get.agent_predictionOpacity}),stateManager.call("drawPredictionTiles"),this.stateManager.get("elements2D").cross.spriteFrame=R.get.cross_predict,!0===levelObject.sound&&this.stateManager.get("sounds").prediction.play(),state.isPredicting=!0,state.currentTrialData.startPrediction=stateManager.timeInMs;var endResponse=levelObject.predictionDuration;this.stateManager.newEvent(R.get.events_responseTimeEnded,endResponse,null,["stateRunningEventsLvl"+levelObject.level])},endPrediction=function(){if(void 0===this.state.currentTrialData)throw new Error("state.startPrediction: currentTrialData is undefined");var stateManager=this.stateManager,state=this.state,R=stateManager.R,levelObject=stateManager.get("levelObject"),cross=this.stateManager.get("elements2D").cross;if(state.isPredicting=!1,4===levelObject.level){state.currentTrialData.endPrediction=stateManager.timeInMs,null!==this.state.currentTrialData.choice?cross.spriteFrame=R.get.crossLockByPosition[this.state.currentTrialData.choice-1]:cross.spriteFrame=R.get.cross_base;var _endPrediction2=levelObject.fixedISIAfterPrediction+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterPrediction,null,levelObject.maxSampleAfterPrediction,levelObject.maxSampleAfterPrediction);this.stateManager.newEvent(R.get.events_goNextPosition,_endPrediction2,null,["stateRunningEventsLvl"+levelObject.level])}else state.currentTrialData.endPrediction=stateManager.timeInMs,this.stateManager.newEvent(R.get.events_goNextPosition,null,null,["stateRunningEventsLvl"+levelObject.level]);return"state.endPrediction: resolved"},checkForClickPrediction=function(){var event=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();try{if(void 0===this.taskObject)throw new Error("state.checkForClickPrediction: this.taskObject is undefined");if(void 0===event.data.clientY)throw new Error("state.checkForClickPrediction: event.data.clientY is undefined.");if(void 0===this.state.currentTrialData)throw new Error("state.checkForClickPrediction: options.trialData is undefined");var stateManager=this.stateManager;this.state.currentTrialData.clicks.push([event.data.engineX,event.data.engineY,stateManager.timeInMs])}catch(e){(0,_experimentJs.debugError)(e)}return"checkForClickPrediction resolved"},checkKeyStrokeForPrediction=function(){var event=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();try{if(void 0===this.taskObject)throw new Error("state.checkKeyStrokeForPrediction: this.taskObject is undefined");if(void 0===event.data.keyCode)throw new Error("state.startPrediction: event.data.keyCode is undefined");if(void 0===this.state.currentTrialData)throw new Error("state.startPrediction: state.currentTrialData is undefined");var stateManager=this.stateManager,state=this.state,R=this.R,levelObject=stateManager.get("levelObject"),keyCode=event.data.keyCode,key=event.data.key;_lodash2.default.has(state,"currentTrialData.keysHits")&&((0,_experimentJs.hasConstructor)(_experimentJs.Array,state.currentTrialData.keysHits)||(state.currentTrialData.keysHits=[]),state.currentTrialData.keysHits.push([key,keyCode,stateManager.timeInMs]));var keys={m:[77,3,R.get.cross_bottomRight],d:[68,1,R.get.cross_topLeft],c:[67,4,R.get.cross_bottomLeft],k:[75,2,R.get.cross_topRight]};if(!0===state.isPredicting&&null!==state.currentTrialData.startPrediction&&null===state.currentTrialData.choice){var position=null,cross=1;return _lodash2.default.forEach(keys,function(keyPosition){keyCode===keyPosition[0]&&(position=keyPosition[1],cross=keyPosition[2])}),null!==position?(state.currentTrialData.choice=position,state.currentTrialData.responseTime=stateManager.timeInMs-state.currentTrialData.startPrediction,state.currentTrialData.respondedAt=stateManager.timeInMs,this.stateManager.get("elements2D").cross.spriteFrame=cross,stateManager.call("highlightPosition",{position:position-1}),state.numberOfMissed=0,stateManager.newEvent(R.get.events_hasResponded,null,null,["stateRunningEventsLvl"+levelObject.level]),(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: has chosen position "+position+"."),position):((0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: key did not correspond to state selection keys."),!1)}return(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: already chosen"),!1}catch(e){return(0,_experimentJs.debugError)(e),!1}},playSound=function(event){this.stateManager.getGlobal("sounds")[event.data.name].play()};exports.stateUnfrozen=stateUnfrozen,exports.startRunning=startRunning,exports.goToNextPosition=goToNextPosition,exports.startPrediction=startPrediction,exports.checkForClickPrediction=checkForClickPrediction,exports.checkKeyStrokeForPrediction=checkKeyStrokeForPrediction,exports.endPrediction=endPrediction,exports.playSound=playSound,exports.endObservation=endObservation,exports.pauseTransition=pauseTransition},function(module,exports,__webpack_require__){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.tryoutEnd=exports.tryoutStartPrediction=exports.tryoutGoToNextPosition=exports.tryoutCheckKeyStrokeForPrediction=exports.tryoutEndPrediction=exports.awakeTryout=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_lodash=__webpack_require__(2),_lodash2=_interopRequireDefault(_lodash),_experimentBabylonJs=__webpack_require__(1),_experimentBabylonJs2=_interopRequireDefault(_experimentBabylonJs),_experimentJs=__webpack_require__(0),_tutorial=__webpack_require__(6),_taskUtilities=__webpack_require__(3),awakeTryout=function(){var taskObject=this.taskObject,state=this.state,currentTutorial=this.stateManager.get("currentTutorial",1),stateManager=this.stateManager,elements2D=stateManager.get("elements2D"),R=this.R;elements2D.loader.value=0,stateManager.call("showAll"),state.data=state.data||[],state.isPredicting=!1,state.shouldPause=!0,state.index=-1,stateManager.setGlobal("level","tryout-"+currentTutorial),state.tests={wolfFirstAppears:{title:"Four possible positions",message:"The wolf may appear at any of the four position on the screen.",passed:!1},wolfHasAppeared:{title:"Predict wolf's next position",message:"The wolf has appeared on the top left position. With the keyboard keys predict its next position.<br>\n      D for top left, C for bottom left, K for top right, and M for bottom right.",passed:!1},predictionTest:{title:"Prediction phase",message:"Predict the next position of the wolf {n}/3.",passed:!1,numberOfPrediction:0},realTimeTest:{title:"Now try with the real timing",message:"Congratulations ! Now that you got the gist of it, you will have to predict as fast as possible.",passed:!1},rabbitFirstAppear:{title:"Predict the next position of the Rabbit",message:"Use the keyboard to predict the next position of the rabbit.",passed:!1},rabbitFirstDisapear:{title:R.get.rabbitFirstDisapearTitle,message:R.get.rabbitFirstDisapearMessage,passed:!1},wolfFmriFirstAppear:{title:R.get.wolfFmriFirstAppearTitle,message:R.get.wolfFmriFirstAppearMessage,passed:!1},blackoutFirstAppear:{title:R.get.blackoutFirstAppearTitle,message:R.get.blackoutFirstAppearMessage,passed:!1}},state.hasPassedAllTest=function(){for(var key in state.tests)if(state.tests.hasOwnProperty(key)){var test=state.tests[key];if(!test.passed)return!1}return!0},1===currentTutorial?(state.sequenceObject=(0,_taskUtilities.getFullSequenceObjectForClassicLevels)([1,3,4,2,1,3,4,2,1,3,2,4,2,1,3]),stateManager.setGlobal("levelObject",this.taskObject.parameters.levels[0])):(state.sequenceObject={fullSequence:[1,2,1,3,4,2,1,3,4,3],trial:_lodash2.default.range(1,10),trialType:(0,_experimentJs.rep)(["observation_prediction","blackout"],5),block:(0,_experimentJs.rep)(1,5).concat((0,_experimentJs.rep)(2,5)),blockType:(0,_experimentJs.rep)("random",5).concat((0,_experimentJs.rep)("normal",5))},stateManager.setGlobal("levelObject",taskObject.parameters.levels[3])),this.stateManager.newEvent(this.R.get.events_goNextPosition,null,null,["stateTryout"+currentTutorial])},tryoutGoToNextPosition=function(){var _this=this,stateManager=this.stateManager,state=this.state;state.index+=1;var elements2D=stateManager.get("elements2D"),levelObject=stateManager.get("levelObject"),cross=elements2D.cross,R=this.R,currentTutorial=stateManager.get("currentTutorial",1),index=state.index,sequenceObject=state.sequenceObject;stateManager.hideTooltip();var ntransition=sequenceObject.fullSequence.length;if(index>ntransition-1){if(stateManager.call("hideAll"),1===currentTutorial){var event=new _experimentJs.EventData(this.R.get.flags_levelDefined,stateManager.timeInMs,{level:1});this.taskObject.modal({title:_tutorial.tutorials.askContinue.title.en,content:_tutorial.tutorials.askContinue.content.en,event:event})}else{var _event=new _experimentJs.EventData(this.R.get.flags_levelDefined,stateManager.timeInMs,{level:4});this.taskObject.modal({title:_tutorial.tutorials.askfMRIContinue.title.en,content:_tutorial.tutorials.askfMRIContinue.content.en,event:_event})}return"state.tryoutGoToNextPosition: finished tryout"}elements2D.loader.value=100*index/ntransition;var lastChoice=null;"object"===_typeof(state.currentTrialData)&&"number"==typeof state.currentTrialData.choice&&(lastChoice=parseInt(state.currentTrialData.choice,10));var trialData={level:levelObject.level,fullSequenceIndex:index,block:sequenceObject.block[index],blockType:sequenceObject.blockType[index],trial:sequenceObject.trial[index],trialType:sequenceObject.trialType[index],state:state.stateKey,position:sequenceObject.fullSequence[index],choice:null,responseTime:null,startObservation:null,endObservation:null,respondedAt:null,startPrediction:null,endPrediction:null,nextPosition:null,observedTransitionWasDominant:null,keysHits:[],clicks:[],hasPaused:null};state.data.push(trialData);var dataToStore=state.currentTrialData;try{if(void 0!==state.currentTrialData&&stateManager.get("subject_id")){var _state$currentTrialDa=state.currentTrialData,block=_state$currentTrialDa.block,blockType=_state$currentTrialDa.blockType,trial=_state$currentTrialDa.trial,trialType=_state$currentTrialDa.trialType,position=_state$currentTrialDa.position,choice=_state$currentTrialDa.choice,responseTime=_state$currentTrialDa.responseTime,startObservation=_state$currentTrialDa.startObservation,startPrediction=_state$currentTrialDa.startPrediction,respondedAt=_state$currentTrialDa.respondedAt,endPrediction=_state$currentTrialDa.endPrediction,keysHits=_state$currentTrialDa.keysHits,hasPaused=_state$currentTrialDa.hasPaused,clicks=_state$currentTrialDa.clicks,endObservation=_state$currentTrialDa.endObservation;dataToStore={subject_id:stateManager.get("subject_id"),level:currentTutorial,block:block,block_type:blockType,dominant_structure:levelObject.dominantStructure,dominant_transition_probability:levelObject.dominantProbability,trial:trial,trial_type:trialType,position:position,observation_duration:startPrediction?startPrediction-startObservation:this.timeInMs-startObservation,observed_transition_was_dominant:null,transition_to:sequenceObject.fullSequence[index],subject_choice:choice,response_time:responseTime,correct:parseInt(sequenceObject.fullSequence[index],10)===parseInt(choice,10),key_hits:JSON.stringify(keysHits),clicks:JSON.stringify(clicks),has_paused:hasPaused,start_observation:startObservation,end_observation:endObservation,start_prediction:startPrediction,responded_at:respondedAt,end_prediction:endPrediction,belongsTo:["tryoutData"]},stateManager.storeData(dataToStore)}}catch(e){var message="runningState.goToNextPosition: could not store cwData.";(0,_experimentJs.debugError)(message),stateManager.storeInErrorLog({message:message,timestamp:stateManager.timeInMs,data:dataToStore})}state.currentTrialData=trialData,state.isPredicting=!1;var agentType="wolf";"random"===sequenceObject.blockType[index]&&(agentType="rabbit"),elements2D.agentType!==agentType&&stateManager.call("setAgent",{agent:agentType}),cross.spriteFrame=this.R.get.cross_base,stateManager.call("drawTiles",{withKeys:!1}),stateManager.call("moveAgentToTile",{tile:trialData.position-1,opacity:1});var promise=Promise.resolve();return 1!==currentTutorial||state.tests.wolfFirstAppears.passed?2!==currentTutorial||state.tests.rabbitFirstAppear.passed?2!==currentTutorial||"blackout"!==sequenceObject.trialType[index-1]||state.tests.blackoutFirstAppear.passed?2!==currentTutorial||"normal"!==sequenceObject.blockType[index]||state.tests.wolfFmriFirstAppear.passed||(promise=this.taskObject.modal({title:state.tests.wolfFmriFirstAppear.title,content:state.tests.wolfFmriFirstAppear.message}),state.tests.wolfFmriFirstAppear.passed=!0):(promise=this.taskObject.modal({title:state.tests.blackoutFirstAppear.title,content:state.tests.blackoutFirstAppear.message}),state.tests.blackoutFirstAppear.passed=!0):(promise=this.taskObject.modal({title:state.tests.rabbitFirstAppear.title,content:state.tests.rabbitFirstAppear.message}),state.tests.rabbitFirstAppear.passed=!0):(promise=this.taskObject.modal({title:state.tests.wolfFirstAppears.title,content:state.tests.wolfFirstAppears.message}),state.tests.wolfFirstAppears.passed=!0),promise.then(function(){trialData.startObservation=stateManager.timeInMs;var promise=Promise.resolve(),centerPosition=(0,_experimentJs.sizeToVec)(_this.taskObject.renderSize).scale(.5);if(0!==index&&"blackout"!==sequenceObject.trialType[index-1]&&sequenceObject.blockType[index-1]===sequenceObject.blockType[index])if(lastChoice===sequenceObject.fullSequence[index]){var background=new _experimentBabylonJs2.default.Color4(.1,.7,.1,.9),text="Correct!",duration=2e3;1!==currentTutorial||state.tests.predictionTest.passed||(text+="\nHit a key to continue",promise=stateManager.resolveOnKey(),duration=promise);var _position=centerPosition,tilePosition=stateManager.call("getTilePositions")[lastChoice-1];_position=tilePosition,stateManager.tooltip({position:_position,background:background,text:text,duration:duration})}else{var _background=new _experimentBabylonJs2.default.Color4(.7,.1,.1,.9),_position2=centerPosition;if((0,_experimentJs.hasConstructor)(Number,lastChoice)){var _tilePosition=stateManager.call("getTilePositions")[lastChoice-1];_position2=_tilePosition}var _text="Incorrect!",_duration=2e3;1!==currentTutorial||state.tests.predictionTest.passed||(_text+="\nHit a key to continue",promise=stateManager.resolveOnKey(),_duration=promise),stateManager.tooltip({position:_position2,background:_background,text:_text,duration:_duration})}return 1===currentTutorial&&!state.tests.predictionTest.passed&&state.tests.predictionTest.numberOfPrediction>=3&&(state.tests.predictionTest.passed=!0,promise=stateManager.resolveOnKey(),stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,centerPosition.y-100)),text:state.tests.realTimeTest.message+"\nHit a key to continue",duration:promise})),promise}).then(function(){if(trialData.startObservation=stateManager.timeInMs,stateManager.newEvent(R.get.events_endObservation,levelObject.observationDuration,null,["stateRunningEventsLvl"+levelObject.level]),1===currentTutorial){var nextTransitionTime=trialData.startObservation+levelObject.observationDuration+_lodash2.default.random(levelObject.minISIAfterLearning,levelObject.maxISIAfterLearning);stateManager.newEvent(_this.R.get.events_startPrediction,nextTransitionTime,null,["stateTryout"+currentTutorial])}else if("blackout"===sequenceObject.trialType[index]){var observationTime=levelObject.observationDuration+levelObject.fixedISIAfterObservation+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterObservation,0,levelObject.maxSampleAfterObservation,levelObject.maxSampleAfterObservation);(0,_experimentJs.delay)(observationTime).then(function(){stateManager.newEvent(R.get.events_screenWentBlack,null,["stateRunningEventsLvl"+levelObject.level]),stateManager.call("setAgentOpacity",{opacity:0})});var blackoutTime=observationTime+levelObject.fixedBlackScreenDuration+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanBlackScreen,0,levelObject.maxSampleBlackScreen,levelObject.maxSampleBlackScreen);stateManager.newEvent(R.get.events_goNextPosition,blackoutTime,null,["stateRunningEventsLvl"+levelObject.level])}else if("observation_prediction"===sequenceObject.trialType[index]){var _observationTime=stateManager.timeInMs+levelObject.observationDuration+levelObject.fixedISIAfterObservation;_observationTime+=(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterObservation,0,levelObject.maxSampleAfterObservation,levelObject.maxSampleAfterObservation),(0,_experimentJs.debugWarn)("Observation Time",(_observationTime-stateManager.timeInMs)/1e3),stateManager.newEvent(R.get.events_startPrediction,_observationTime,["stateRunningEventsLvl"+levelObject.level])}else(0,_experimentJs.debugError)("Error in sequence",sequenceObject)}),"tryoutGoToNextPosition: finish sync call"},tryoutStartPrediction=function(){var _this2=this,state=this.state,stateManager=this.stateManager,R=stateManager.R,currentTutorial=stateManager.get("currentTutorial",1),levelObject=stateManager.get("levelObject");stateManager.promise("setAgentOpacity",{opacity:R.get.agent_predictionOpacity});var cross=stateManager.get("elements2D").cross;cross.spriteFrame=R.get.cross_predict;var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5),npred=state.tests.predictionTest.numberOfPrediction,promise=Promise.resolve();if(1!==currentTutorial||state.tests.predictionTest.passed)stateManager.call("drawPredictionTiles");else{stateManager.call("drawPredictionTiles",{withKeys:"dkmc"}),promise=stateManager.resolveOnKey(),stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,centerPosition.y-100)),text:state.tests.predictionTest.message.replace("{n}",npred+1)+"\n"+R.get.hitAKeyToContinue,duration:promise,event:new _experimentJs.EventData("predictionTextDismissed")});var text=R.get.changeCenterSquare;stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,-50)),text:text,duration:promise})}promise.then(function(){if(state.isPredicting=!0,state.currentTrialData.startPrediction=stateManager.timeInMs,1!==currentTutorial||state.tests.predictionTest.passed)if(1===currentTutorial)stateManager.newEvent(R.get.events_responseTimeEnded,stateManager.timeInMs+levelObject.predictionDuration,null,["stateTryout"+currentTutorial]);else{stateManager.call("setAgentOpacity",{opacity:0});var endResponse=levelObject.predictionDuration;(0,_experimentJs.delay)(endResponse).then(function(){_this2.state.isPredicting=!1,null!==_this2.state.currentTrialData.choice?cross.spriteFrame=R.get.crossLockByPosition[_this2.state.currentTrialData.choice-1]:cross.spriteFrame=R.get.cross_base});var endPrediction=endResponse+levelObject.fixedISIAfterPrediction+(0,_taskUtilities.sampleExponential)(levelObject.sampleMeanISIAfterPrediction,null,levelObject.maxSampleAfterPrediction,levelObject.maxSampleAfterPrediction);_this2.stateManager.newEvent(R.get.events_goNextPosition,endPrediction,null,["stateTryout"+currentTutorial])}else{var choiceDeferred=new _experimentJs.Deferred;state.choiceDeferred=choiceDeferred;var _text2=R.get.chooseNextPosition;stateManager.tooltip({position:centerPosition,background:null,text:_text2,duration:choiceDeferred.promise}),choiceDeferred.promise.then(function(){stateManager.newEvent(R.get.events_responseTimeEnded,stateManager.timeInMs+levelObject.predictionDuration,null,["stateTryout"+currentTutorial])})}})},tryoutCheckKeyStrokeForPrediction=function(){var event=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,_experimentJs.mandatory)();if(void 0===event.data.keyCode)throw new Error("state.checkKeyStrokeForPrediction: event.data.keyCode is undefined");var stateManager=this.stateManager,state=this.state,R=this.R,currentTutorial=stateManager.get("currentTutorial",1),keyCode=event.data.keyCode,key=event.data.key,keys={m:[77,3,R.get.cross_bottomRight],d:[68,1,R.get.cross_topLeft],c:[67,4,R.get.cross_bottomLeft],k:[75,2,R.get.cross_topRight]};if(_lodash2.default.has(state,"currentTrialData.keysHits")&&((0,_experimentJs.hasConstructor)(_experimentJs.Array,state.currentTrialData.keysHits)||(state.currentTrialData.keysHits=[]),state.currentTrialData.keysHits.push([key,keyCode,stateManager.timeInMs])),!0===state.isPredicting&&null!==state.currentTrialData.startPrediction&&null===state.currentTrialData.choice){var position=null,cross=1,chosenKey=null;for(var _key in keys)if(keys.hasOwnProperty(_key)){var keyPosition=keys[_key];keyCode===keyPosition[0]&&(position=keyPosition[1],cross=keyPosition[2],chosenKey=_key)}if(null!==position){if((0,_experimentJs.hasConstructor)(_experimentJs.Deferred,state.choiceDeferred)&&(state.choiceDeferred.resolve(),state.choiceDeferred=null),state.currentTrialData.choice=position,state.currentTrialData.responseTime=stateManager.timeInMs-state.currentTrialData.startPrediction,state.currentTrialData.respondedAt=stateManager.timeInMs,this.stateManager.get("elements2D").cross.spriteFrame=cross,!state.tests.predictionTest.passed){state.tests.predictionTest.numberOfPrediction+=1;var centerPosition=(0,_experimentJs.sizeToVec)(this.taskObject.renderSize).scale(.5),tilePosition=stateManager.call("getTilePositions")[position-1],sign=Math.sign(centerPosition.subtract(tilePosition).x);tilePosition=tilePosition.add(new _experimentBabylonJs2.default.Vector2(50*sign,50*sign)),stateManager.tooltip({position:tilePosition,text:R.get.youSelectedThisTile+" ("+chosenKey+")",duration:(0,_experimentJs.delay)(2e3)});var text=R.get.aLittleSquareShowsYourChoice;stateManager.tooltip({position:centerPosition.add(new _experimentBabylonJs2.default.Vector2(0,-50)),text:text,duration:2e3})}return state.numberOfMissed=0,stateManager.newEvent(R.get.events_hasResponded,null,null,["stateTryout"+currentTutorial]),(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: has chosen position "+position+"."),position}return(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: key did not correspond to state selection keys."),!1}return(0,_experimentJs.debuglog)("state.checkKeyStrokeForPrediction: not a valid time to choose or already chosen"),!1},tryoutEndPrediction=function(){var stateManager=this.stateManager,state=this.state,R=this.R,currentTutorial=stateManager.get("currentTutorial",1);return state.isPredicting=!1,state.currentTrialData.endPrediction=stateManager.timeInMs,stateManager.newEvent(R.get.events_goNextPosition,null,null,["stateTryout"+currentTutorial]),"state.endPrediction: resolved"},tryoutEnd=function(){var stateManager=this.stateManager,R=this.R,currentTutorial=stateManager.get("currentTutorial",1);this.taskObject.setCheckpoint(R.get.checkpoint_tutorialDone[currentTutorial-1])};exports.awakeTryout=awakeTryout,exports.tryoutEndPrediction=tryoutEndPrediction,exports.tryoutCheckKeyStrokeForPrediction=tryoutCheckKeyStrokeForPrediction,exports.tryoutGoToNextPosition=tryoutGoToNextPosition,exports.tryoutStartPrediction=tryoutStartPrediction,exports.tryoutEnd=tryoutEnd},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_15__},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE_16__}])});